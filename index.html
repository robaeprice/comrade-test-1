<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The fairer way to split costs with friends.">
    <title>Comrade</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body style="margin: 0; padding: 0;">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useMemo } = React;






const applyWeighting = (wealth, weighting) => {
  if (weighting === 'none') return 1;
  if (weighting === 'gentle') return Math.sqrt(wealth);
  if (weighting === 'strong') return wealth * wealth;
  return wealth;
};

const QUOTES = ['BREAD AND ROSES','NO MAN IS AN ISLAND','BE EXCELLENT TO EACH OTHER','WHICH SIDE ARE YOU ON?','SALUS POPULI SUPREMA LEX','WHAT GOES AROUND COMES AROUND','IT TAKES A VILLAGE','A COMMON TREASURY OF RELIEF FOR ALL, BOTH BEASTS AND MEN','E PLURIBUS UNUM','VIVE LA COMMUNE','SHARE THE LOAD','YOU GET WHAT YOU GIVE','WE\'RE ALL IN THIS TOGETHER','FOR WHAT SHALL IT PROFIT A MAN, IF HE SHALL GAIN THE WORLD, AND LOSE HIS OWN SOUL?','THANKS FOR SHARING','REND DOWN THE HEDGES','ALL TOGETHER NOW','WHAT\'S MINE IS YOURS, AND WHAT IS YOURS IS MINE','I DON\'T WANT YOUR MILLIONS, MISTER','AM I MY BROTHER\'S KEEPER?','WHO BUILT THEBES OF THE SEVEN GATES?','JEDER NACH SEINEN FÃ„HIGKEITEN, JEDEM NACH SEINEN BEDÃœRFNISSEN','A RISING TIDE LIFTS ALL BOATS','ONE HAND WASHES THE OTHER','FAIR\'S FAIR','WHEN ADAM DELVED AND EVE SPAN, WHO WAS THEN THE GENTLEMAN?','ALL FOR ONE AND ONE FOR ALL','LIBERTÃ‰, Ã‰GALITÃ‰, FRATERNITÃ‰','GIVE US THIS DAY OUR DAILY BREAD','NO ONE LEFT BEHIND','THE WISDOM OF THE CROWD','AND ALL THAT BELIEVED WERE TOGETHER, AND HAD ALL THINGS IN COMMON','SO THE LAST SHALL BE FIRST, AND THE FIRST LAST','SHARE AND SHARE ALIKE','MANY HANDS MAKE LIGHT WORK','IN CHEAPSIDE SHALL MY PALFREY GO TO GRASS'];

const EXAMPLE_DATA = {
  share: { people: [{id:1,name:'Lucy',wealth:'32000'},{id:2,name:'Susan',wealth:'180000'},{id:3,name:'Edmund',wealth:'45000'},{id:4,name:'Peter',wealth:'95000'}], bills: [{id:5,description:'Ski passes',amount:'1200',paidBy:'Susan'},{id:6,description:'Cabin rental',amount:'2400',paidBy:'Peter'},{id:7,description:'Gas',amount:'110',paidBy:'Lucy'},{id:8,description:'Groceries',amount:'520',paidBy:'Susan'},{id:9,description:'Gear rental',amount:'805',paidBy:'Edmund'}] },
  sale: { productName:'Used Honda Civic',numberAvailable:'1', buyers:[{id:1,name:'Riley',wealth:'28000',offer:'4800'},{id:2,name:'Casey',wealth:'75000',offer:'5200'},{id:3,name:'Taylor',wealth:'140000',offer:'5500'},{id:4,name:'Drew',wealth:'220000',offer:'6000'}] },
  vote: { decision:"What should the company's remote work policy be?", options:[{id:1,text:'Fully remote'},{id:2,text:'Hybrid'},{id:3,text:'100% in-office'}], participants:[{id:5,name:'Oscar',wealth:'250000',vote:'100% in-office'},{id:6,name:'Gerry',wealth:'120000',vote:'Hybrid'},{id:7,name:'Sarah',wealth:'65000',vote:'Fully remote'},{id:8,name:'Simone',wealth:'110000',vote:'Fully remote'},{id:9,name:'Thomas',wealth:'85000',vote:'Hybrid'}] },
  rent: { totalRent:'3600',totalUtilities:'240', people:[{id:1,name:'Marie',roomSize:'180',wealth:'42000'},{id:2,name:'Toulouse',roomSize:'140',wealth:'125000'},{id:3,name:'Berlioz',roomSize:'160',wealth:'68000'}] }
};

const BG_GREY = '#F3F4F6';
const DARK = '#333333';

const BG_STYLE = (() => {
  const h=145, w=Math.round(h*75/90), fs=Math.round(h*18/90), op=(20/100).toFixed(2);
  const fracs=[[10/75,20/90],[35/75,20/90],[60/75,20/90],[3/75,50/90],[28/75,50/90],[53/75,50/90],[17/75,80/90],[42/75,80/90],[67/75,80/90]];
  const syms=['$','â‚¬','Â£','â‚¬','Â£','$','Â£','$','â‚¬'];
  const textEls=fracs.map(([xf,yf],i)=>`<text x="${Math.round(xf*w)}" y="${Math.round(yf*h)}" font-family="Sixtyfour,monospace" font-size="${fs}" fill="${BG_GREY}" fill-opacity="${op}" font-weight="bold">${syms[i]}</text>`).join('');
  const svg=`<svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg">${textEls}</svg>`;
  const cycleLength=1050, half=cycleLength/2;
  return {
    backgroundImage:`url("data:image/svg+xml,${encodeURIComponent(svg)}"),repeating-linear-gradient(135deg,#ffd700 0px,#ff8c00 ${half}px,#ffd700 ${cycleLength}px)`,
    backgroundSize:'auto, auto', backgroundRepeat:'repeat, no-repeat',
    backgroundAttachment:'scroll, scroll', minHeight:'100vh',
  };
})();

const SHARE_KEY = 'comrade_share';
const RENT_KEY  = 'comrade_rent';
const SALE_KEY  = 'comrade_sale';
const VOTE_KEY  = 'comrade_vote';
const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

const readStorage = (key) => {
  try {
    const d = JSON.parse(localStorage.getItem(key)||'null');
    if (!d) return null;
    if (d.lastUpdated && Date.now() - d.lastUpdated > THIRTY_DAYS) {
      localStorage.removeItem(key);
      return null;
    }
    return d;
  } catch { return null; }
};

const PersonIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 40 40" style={{flexShrink:0}}><circle cx="20" cy="20" r="18" fill={DARK}/><circle cx="20" cy="16" r="5" fill={BG_GREY}/><path d="M 10 32 Q 10 24 20 24 Q 30 24 30 32" fill={BG_GREY}/></svg>;
const BillIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><text x="4" y="20" fontFamily="monospace" fontSize="22" fill={DARK} fontWeight="bold">$</text></svg>;
const HouseIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z" fill={DARK}/></svg>;
const TagIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z" fill={DARK}/></svg>;
const ToteFilledIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><rect x="3" y="8" width="18" height="13" rx="1" fill={DARK}/><path d="M8 8V6a4 4 0 018 0v2" fill="none" stroke={DARK} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>;
const CheckCircleIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><circle cx="12" cy="12" r="11" fill={DARK}/><polyline points="7,12.5 10.5,16 17,9" fill="none" stroke={BG_GREY} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>;
const QuestionIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><text x="6" y="19" fontFamily="monospace" fontSize="20" fill={DARK} fontWeight="bold">?</text></svg>;
const CalculateIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><line x1="4" y1="9" x2="20" y2="9" stroke={DARK} strokeWidth="3.5" strokeLinecap="round"/><line x1="4" y1="15" x2="20" y2="15" stroke={DARK} strokeWidth="3.5" strokeLinecap="round"/></svg>;
const ListIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><rect x="4" y="5" width="3" height="3" fill={DARK}/><rect x="4" y="10" width="3" height="3" fill={DARK}/><rect x="4" y="15" width="3" height="3" fill={DARK}/><line x1="9" y1="6.5" x2="20" y2="6.5" stroke={DARK} strokeWidth="2"/><line x1="9" y1="11.5" x2="20" y2="11.5" stroke={DARK} strokeWidth="2"/><line x1="9" y1="16.5" x2="20" y2="16.5" stroke={DARK} strokeWidth="2"/></svg>;
const ErrorIcon = ({size=20}) => <svg width={size} height={size} viewBox="0 0 24 24" style={{flexShrink:0}}><line x1="4" y1="4" x2="20" y2="20" stroke={DARK} strokeWidth="3"/><line x1="20" y1="4" x2="4" y2="20" stroke={DARK} strokeWidth="3"/></svg>;

const scrollToStep = i => setTimeout(() => {
  const el = document.getElementById(`accordion-step-${i}`);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}, 80);

const FaqItem = ({q,a,render,border}) => {
  const [open,setOpen] = useState(false);
  return (
    <div className={border?'border-b-2 border-dashed border-gray-400':''}>
      <button onClick={()=>setOpen(o=>!o)} className="w-full flex items-center gap-3 p-5 text-left hover:opacity-60 transition-all">
        <QuestionIcon size={18}/>
        <span className="flex-1 font-bold text-sm text-black uppercase tracking-wide leading-snug">{q}</span>
        <span className="text-2xl font-black text-black ml-2 leading-none flex-shrink-0">{open?'âˆ’':'+'}</span>
      </button>
      {open&&<div className="px-5 pb-5 animate-fadeIn">{render??a.split('\n\n').map((para,j)=><p key={j} className="leading-relaxed text-xs mb-2 text-black">{para}</p>)}</div>}
    </div>
  );
};

const DetailToggleButton = ({show, onClick}) => (
  <div style={{borderTop:'2px dashed #9CA3AF', borderBottom:'2px dashed #9CA3AF', marginBottom:'24px'}}>
    <button
      onClick={onClick}
      style={{background:'transparent', border:'0', width:'100%', display:'flex', alignItems:'center', gap:'12px', padding:'20px', cursor:'pointer', textAlign:'left'}}
      className="hover:opacity-60 transition-all"
    >
      <span style={{flex:1, fontWeight:900, fontSize:'14px', color:DARK, textTransform:'uppercase', letterSpacing:'0.05em', lineHeight:1.3}}>
        {show ? 'HIDE BREAKDOWN' : 'SHOW BREAKDOWN'}
      </span>
      <span style={{fontSize:'24px', fontWeight:900, color:DARK, lineHeight:1, flexShrink:0}}>{show ? 'âˆ’' : '+'}</span>
    </button>
  </div>
);

const AboutBanner = () => (
  <div className="mb-6"><div className="bg-white p-4">
    <svg width="100%" height="60" viewBox="0 0 600 60" preserveAspectRatio="xMidYMid meet">
      <g transform="translate(50,30)"><text x="0" y="12" fontFamily="monospace" fontSize="32" fill={DARK} fontWeight="bold" textAnchor="middle">$</text></g>
      <g transform="translate(150,30)"><rect x="-30" y="8" width="12" height="15" fill={DARK}/><rect x="-15" y="-3" width="12" height="26" fill="#666"/><rect x="0" y="5" width="12" height="18" fill="#999"/><rect x="15" y="-8" width="12" height="31" fill={DARK}/><line x1="-30" y1="23" x2="27" y2="23" stroke={DARK} strokeWidth="2"/></g>
      <g transform="translate(250,30)"><text x="0" y="12" fontFamily="monospace" fontSize="32" fill={DARK} fontWeight="bold" textAnchor="middle">â‚¬</text></g>
      <g transform="translate(350,30)"><circle cx="0" cy="0" r="18" fill="#666"/><circle cx="0" cy="-4" r="5" fill={BG_GREY}/><path d="M -10 12 Q -10 4 0 4 Q 10 4 10 12" fill={BG_GREY}/></g>
      <g transform="translate(450,30)"><text x="0" y="12" fontFamily="monospace" fontSize="32" fill={DARK} fontWeight="bold" textAnchor="middle">Â£</text></g>
      <g transform="translate(550,30)"><path d="M 0 0 L 0 -22 A 22 22 0 0 1 15.6 15.6 Z" fill={DARK}/><path d="M 0 0 L 15.6 15.6 A 22 22 0 0 1 -11 19 Z" fill="#666"/><path d="M 0 0 L -11 19 A 22 22 0 0 1 -21.1 -5.7 Z" fill="#999"/><path d="M 0 0 L -21.1 -5.7 A 22 22 0 0 1 0 -22 Z" fill="#CCC"/></g>
    </svg>
  </div></div>
);

const PeopleAvatars = () => (
  <div className="flex justify-center gap-2 py-2">
    {['#D1D5DB','#9CA3AF','#6B7280'].map((c,i)=>(<svg key={i} width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="18" fill={c}/><circle cx="20" cy="16" r="6" fill={BG_GREY}/><path d="M 10 32 Q 10 24 20 24 Q 30 24 30 32" fill={BG_GREY}/></svg>))}
  </div>
);
const MockReceipt = () => (
  <div className="flex justify-center py-2 px-16">
    <div className="space-y-2 w-full">
      {[['#D1D5DB','MEAL','$95'],['#9CA3AF','GAS','$45'],['#6B7280','HOTEL','$300']].map(([color,label,amount])=>(
        <div key={label} className="flex justify-between items-center text-xs font-bold text-gray-500 border-b-2 border-dashed border-gray-400 pb-1">
          <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor:color}}></div><span>{label}</span></div>
          <span>{amount}</span>
        </div>
      ))}
    </div>
  </div>
);
const ResultPieChart = () => (
  <div className="flex justify-center py-2">
    <svg width="80" height="80" viewBox="0 0 80 80">
      <rect width="80" height="80" fill={BG_GREY}/>
      <path d="M 40 5 A 35 35 0 0 1 52.5 71.2 L 40 40 Z" fill="#D1D5DB" stroke={BG_GREY} strokeWidth="2"/>
      <path d="M 40 40 L 52.5 71.2 A 35 35 0 0 1 8.8 52.5 L 40 40 Z" fill="#9CA3AF" stroke={BG_GREY} strokeWidth="2"/>
      <path d="M 40 40 L 8.8 52.5 A 35 35 0 0 1 40 5 L 40 40 Z" fill="#6B7280" stroke={BG_GREY} strokeWidth="2"/>
    </svg>
  </div>
);

const DashedDivider = () => <div className="border-t-2 border-dashed border-gray-400 my-6"/>;
const CurrencyDivider = () => (
  <div className="flex items-center gap-4 my-6">
    <div className="flex-1 border-t-4" style={{borderColor:DARK}}></div>
    <span className="text-xs font-bold sf">$ â‚¬ Â£</span>
    <div className="flex-1 border-t-4" style={{borderColor:DARK}}></div>
  </div>
);
const BlackBoxStats = ({stats}) => (
  <div className="flex flex-wrap gap-x-5 gap-y-1 mt-4 pt-3 border-t-2 border-dashed" style={{borderColor:BG_GREY}}>
    {stats.map(({label,value})=><div key={label} className="text-xs" style={{color:BG_GREY}}><span>{label}: </span><span className="font-bold">{value}</span></div>)}
  </div>
);

const WeightingButtons = ({value,onChange}) => (
  <div className="flex justify-center">
    <div className="bg-gray-100 p-2 border-2 border-dotted border-black inline-block">
      <div className="flex flex-wrap gap-2">
        {[{value:'none',label:'OFF'},{value:'gentle',label:'LOW'},{value:'standard',label:'MID'},{value:'strong',label:'HIGH'}].map(w=>(
          <button key={w.value} onClick={()=>onChange(w.value)} className={`flex-1 min-w-[100px] p-3 font-bold text-xs border-2 ${value===w.value?'bg-black text-white border-black':w.value==='none'?'bg-gray-200 text-gray-500 border-gray-400':'bg-white text-black border-gray-400'}`}>{w.label}</button>
        ))}
      </div>
    </div>
  </div>
);

const numericKeyDown = e => {
  const allowed=['Backspace','Delete','Tab','Escape','Enter','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End','.'];
  if(allowed.includes(e.key)||e.ctrlKey||e.metaKey) return;
  if(!/^\d$/.test(e.key)) e.preventDefault();
};

const FormInput = ({type='text',value,onChange,placeholder,className='',style,...props}) => {
  const base="w-full p-2 border-2 border-gray-400 bg-white uppercase";
  if(type==='textarea') return <textarea value={value} onChange={onChange} placeholder={placeholder} className={`${base} ${className}`} style={{fontSize:'16px',...style}} {...props}/>;
  return <input type={type} value={value} onChange={onChange} onKeyDown={type==='number'?numericKeyDown:undefined} placeholder={placeholder} className={`${base} ${className}`} style={{fontSize:'16px',...style}} {...props}/>;
};

const ItemList = ({items,onDelete,renderItem,receiptStyle,formatTotal,getAmount}) => {
  if(!items.length) return null;
  if(receiptStyle) {
    const total=items.reduce((s,i)=>s+(parseFloat(getAmount?getAmount(i):i.amount)||0),0);
    return (
      <div className="mt-4">
        <div className="space-y-0 mb-4">
          {items.map(item=>(
            <div key={item.id} className="flex justify-between items-start text-xs text-black border-b border-dashed border-gray-400 pb-2 pt-2">
              <div className="flex-1">{renderItem(item)}</div>
              <div className="flex items-center gap-3">
                <span className="text-black font-bold">{formatTotal?formatTotal(parseFloat(getAmount?getAmount(item):item.amount)||0):(parseFloat(getAmount?getAmount(item):item.amount)||0).toFixed(2)}</span>
                <button onClick={()=>onDelete(item.id)} className="text-black font-bold text-xl hover:text-gray-600 leading-none">Ã—</button>
              </div>
            </div>
          ))}
        </div>
        <div className="flex justify-between items-center pt-3 border-t-2 border-black">
          <span className="font-black text-black uppercase sf">TOTAL</span>
          <span className="font-black text-black text-lg sf">{formatTotal?formatTotal(total):total.toFixed(2)}</span>
        </div>
      </div>
    );
  }
  return (
    <div className="mt-4 space-y-2">
      {items.map(item=>(
        <div key={item.id} className="bg-white p-3 border-2 border-black flex justify-between items-center">
          <div className="flex-1">{renderItem(item)}</div>
          <button onClick={()=>onDelete(item.id)} className="text-black font-bold text-xl ml-3 hover:text-gray-600">Ã—</button>
        </div>
      ))}
    </div>
  );
};

const AccordionPage = ({steps,openIndices,onToggle,renderContent}) => (
  <div>
    {steps.map((s,i)=>{
      const isOpen=openIndices.includes(i);
      return (
        <div key={i} id={`accordion-step-${i}`} className={i>0?'border-t-2 border-dashed border-gray-400':''}>
          <button onClick={(e)=>{const opening=!isOpen;onToggle(i);if(opening)setTimeout(()=>e.currentTarget.scrollIntoView({behavior:'smooth',block:'start'}),0);}} className="w-full flex items-center justify-between py-4 px-1 text-left hover:opacity-60 transition-all">
            <div className="flex items-center gap-3" style={{opacity:isOpen?1:0.5}}>
              {s.icon}
              <div>
                {i>0&&<p className="text-xs text-gray-500 font-bold uppercase">STEP {i} OF {steps.length-1}</p>}
                <p className="font-black text-xl uppercase text-black leading-tight">{s.label}</p>
              </div>
            </div>
            <span className="text-3xl font-black text-black ml-4 leading-none flex-shrink-0">{isOpen?'âˆ’':'+'}</span>
          </button>
          {isOpen&&<div className="pb-4 px-1 animate-fadeIn">{renderContent(i)}</div>}
        </div>
      );
    })}
  </div>
);

const ReceiptTop = () => (
  <svg width="100%" height="32" viewBox="0 0 600 32" preserveAspectRatio="none" style={{display:'block'}}>
    <polygon points="0,4 21.428,14 42.857,4 64.286,14 85.714,4 107.143,14 128.571,4 150,14 171.429,4 192.857,14 214.286,4 235.714,14 257.143,4 278.571,14 300,4 321.429,14 342.857,4 364.286,14 385.714,4 407.143,14 428.571,4 450,14 471.429,4 492.857,14 514.286,4 535.714,14 557.143,4 578.571,14 600,4 600,32 0,32" fill={BG_GREY}/>
    <polygon points="0,0 21.428,10 42.857,0 64.286,10 85.714,0 107.143,10 128.571,0 150,10 171.429,0 192.857,10 214.286,0 235.714,10 257.143,0 278.571,10 300,0 321.429,10 342.857,0 364.286,10 385.714,0 407.143,10 428.571,0 450,10 471.429,0 492.857,10 514.286,0 535.714,10 557.143,0 578.571,10 600,0 600,4 578.571,14 557.143,4 535.714,14 514.286,4 492.857,14 471.429,4 450,14 428.571,4 407.143,14 385.714,4 364.286,14 342.857,4 321.429,14 300,4 278.571,14 257.143,4 235.714,14 214.286,4 192.857,14 171.429,4 150,14 128.571,4 107.143,14 85.714,4 64.286,14 42.857,4 21.428,14 0,4" fill={DARK}/>
  </svg>
);
const ReceiptBottom = () => (
  <svg width="100%" height="32" viewBox="0 0 600 32" preserveAspectRatio="none" style={{display:'block',marginTop:'-2px'}}>
    <polygon points="0,0 600,0 600,28 578.571,18 557.143,28 535.714,18 514.286,28 492.857,18 471.429,28 450,18 428.571,28 407.143,18 385.714,28 364.286,18 342.857,28 321.429,18 300,28 278.571,18 257.143,28 235.714,18 214.286,28 192.857,18 171.429,28 150,18 128.571,28 107.143,18 85.714,28 64.286,18 42.857,28 21.428,18 0,28" fill={BG_GREY}/>
    <polygon points="0,32 21.428,22 42.857,32 64.286,22 85.714,32 107.143,22 128.571,32 150,22 171.429,32 192.857,22 214.286,32 235.714,22 257.143,32 278.571,22 300,32 321.429,22 342.857,32 364.286,22 385.714,32 407.143,22 428.571,32 450,22 471.429,32 492.857,22 514.286,32 535.714,22 557.143,32 578.571,22 600,32 600,28 578.571,18 557.143,28 535.714,18 514.286,28 492.857,18 471.429,28 450,18 428.571,28 407.143,18 385.714,28 364.286,18 342.857,28 321.429,18 300,28 278.571,18 257.143,28 235.714,18 214.286,28 192.857,18 171.429,28 150,18 128.571,28 107.143,18 85.714,28 64.286,18 42.857,28 21.428,18 0,28" fill={DARK}/>
  </svg>
);

let _legalCount = 0;
let _legalTimer = null;

const FooterNav = ({onNavigate, onClearStorage}) => {
  const [toast, setToast] = useState(false);

  const handleLegalClick = () => {
    _legalCount++;
    clearTimeout(_legalTimer);
    if (_legalCount >= 3) {
      _legalCount = 0;
      onClearStorage();
      setToast(true);
      setTimeout(() => setToast(false), 2500);
    } else {
      _legalTimer = setTimeout(() => { _legalCount = 0; }, 1500);
      onNavigate('legal');
    }
  };

  const resetCount = dest => { _legalCount = 0; clearTimeout(_legalTimer); onNavigate(dest); };

  return (
    <div className="text-center mt-4 mb-4 text-black text-xs">
      <span className="cursor-pointer hover:underline font-bold sf" onClick={()=>resetCount('home')}>HOME</span>
      <span className="mx-3 sf">/</span>
      <span className="cursor-pointer hover:underline font-bold sf" onClick={()=>resetCount('about')}>ABOUT</span>
      <span className="mx-3 sf">/</span>
      <span className="cursor-pointer hover:underline font-bold sf" onClick={handleLegalClick}>LEGAL</span>
      {toast && (
        <div className="animate-fadeIn" style={{position:'fixed',bottom:32,left:'50%',transform:'translateX(-50%)',padding:'10px 24px',fontWeight:'bold',zIndex:9999,border:`2px solid ${DARK}`,backgroundColor:DARK,color:BG_GREY,fontSize:'12px',whiteSpace:'nowrap'}}>
          ðŸ§¹ STORAGE CLEARED
        </div>
      )}
    </div>
  );
};

const Layout = ({children,onNavigate,showCopyToast,loadedAt,onClearStorage}) => (
  <div style={BG_STYLE}>
    <style>{`
      @import url('https://fonts.googleapis.com/css2?family=Sixtyfour:wght@400&display=swap');
      * { font-family: 'Sixtyfour', monospace !important; word-wrap: break-word; overflow-wrap: break-word; }
      html { background-color: #ffd700; }
      html, body { overflow-y: auto !important; height: auto !important; }
      .receipt-wrapper { border-left: 4px solid ${DARK}; border-right: 4px solid ${DARK}; filter: drop-shadow(6px 8px 18px rgba(0,0,0,0.45)); will-change: filter; transform: translateZ(0); }
      .receipt-container { position: relative; background: ${BG_GREY}; }
      .bg-white { background-color: ${BG_GREY} !important; }
      .bg-gray-50 { background-color: #E5E7EB !important; }
      button { white-space: normal; text-align: center; word-wrap: break-word; overflow-wrap: break-word; word-break: keep-all; hyphens: none; overflow: visible; min-height: fit-content; display: flex; align-items: center; justify-content: center; line-height: 1.3; padding: 0.5rem 1rem; margin-left: auto; margin-right: auto; }
      button.calculate-btn { font-size: clamp(1rem, 4vw, 1.25rem); }
      .text-black { color: ${DARK} !important; }
      .bg-black { background-color: ${DARK} !important; }
      .border-black { border-color: ${DARK} !important; }
      .text-white { color: ${BG_GREY} !important; }
      .hover\\:bg-gray-800:hover { background-color: #2a2a2a !important; }
      .currency-pattern { overflow: hidden; white-space: nowrap; text-align: center; }
      @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
      .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
      @keyframes barGrow { from { width: 0; } }
      .bar-animate { animation: barGrow 0.8s ease-out forwards; }
      button:active { transform: scale(0.97); }
    `}</style>
    <div className="max-w-xl mx-auto px-2 sm:px-0 py-5">
      <div className="receipt-wrapper">
        <ReceiptTop />
        <div className="receipt-container">
          <div className="pt-0 px-6 pb-0">
            <div className="bg-white mb-4 pt-3 pb-3 border-b-2 border-dashed border-gray-400">
              <div className="cursor-pointer text-center" onClick={()=>onNavigate('home')}>
                <div className="currency-pattern text-xs text-black uppercase tracking-wider sf" style={{marginBottom:'2px'}}>{'$ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£'}</div>
                <svg width="100%" viewBox="0 0 100 24" style={{display:'block',overflow:'visible',marginBottom:'-6px',marginTop:'-2px'}}>
                  <text x="0" y="19" fontFamily="Sixtyfour,monospace" fontWeight="900" fill={DARK} textLength="100" lengthAdjust="spacingAndGlyphs" fontSize="19">COMRADE</text>
                </svg>
                <div className="currency-pattern text-xs text-black uppercase tracking-wider sf" style={{marginTop:'2px'}}>{'$ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£ $ â‚¬ Â£'}</div>
              </div>
              <p className="text-center text-black font-bold mt-2" style={{fontSize:'10px',letterSpacing:'1px'}}>{loadedAt}</p>
            </div>
            {children}
            <CurrencyDivider />
            <FooterNav onNavigate={onNavigate} onClearStorage={onClearStorage}/>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 464 73" width="100%" style={{display:'block',marginBottom:'8px'}}>
              <rect x="0" y="0" width="464" height="73" fill={BG_GREY}/>
              <g transform="translate(10, 3)" fill={DARK}>
                <rect x="0" y="0" width="4" height="67"/><rect x="6" y="0" width="2" height="67"/><rect x="12" y="0" width="2" height="67"/><rect x="22" y="0" width="8" height="67"/><rect x="34" y="0" width="2" height="67"/><rect x="38" y="0" width="2" height="67"/><rect x="44" y="0" width="8" height="67"/><rect x="56" y="0" width="2" height="67"/><rect x="60" y="0" width="2" height="67"/><rect x="66" y="0" width="8" height="67"/><rect x="78" y="0" width="2" height="67"/><rect x="82" y="0" width="2" height="67"/><rect x="88" y="0" width="2" height="67"/><rect x="94" y="0" width="4" height="67"/><rect x="102" y="0" width="6" height="67"/><rect x="110" y="0" width="2" height="67"/><rect x="120" y="0" width="2" height="67"/><rect x="124" y="0" width="4" height="67"/><rect x="132" y="0" width="2" height="67"/><rect x="140" y="0" width="8" height="67"/><rect x="150" y="0" width="2" height="67"/><rect x="154" y="0" width="8" height="67"/><rect x="164" y="0" width="6" height="67"/><rect x="172" y="0" width="2" height="67"/><rect x="176" y="0" width="2" height="67"/><rect x="182" y="0" width="2" height="67"/><rect x="188" y="0" width="8" height="67"/><rect x="198" y="0" width="2" height="67"/><rect x="204" y="0" width="2" height="67"/><rect x="208" y="0" width="4" height="67"/><rect x="220" y="0" width="2" height="67"/><rect x="230" y="0" width="2" height="67"/><rect x="236" y="0" width="4" height="67"/><rect x="242" y="0" width="2" height="67"/><rect x="246" y="0" width="4" height="67"/><rect x="254" y="0" width="2" height="67"/><rect x="264" y="0" width="2" height="67"/><rect x="270" y="0" width="4" height="67"/><rect x="278" y="0" width="6" height="67"/><rect x="286" y="0" width="8" height="67"/><rect x="296" y="0" width="6" height="67"/><rect x="304" y="0" width="2" height="67"/><rect x="308" y="0" width="2" height="67"/><rect x="316" y="0" width="8" height="67"/><rect x="326" y="0" width="2" height="67"/><rect x="330" y="0" width="4" height="67"/><rect x="342" y="0" width="2" height="67"/><rect x="346" y="0" width="2" height="67"/><rect x="352" y="0" width="2" height="67"/><rect x="356" y="0" width="4" height="67"/><rect x="364" y="0" width="2" height="67"/><rect x="374" y="0" width="4" height="67"/><rect x="380" y="0" width="4" height="67"/><rect x="386" y="0" width="8" height="67"/><rect x="396" y="0" width="6" height="67"/><rect x="404" y="0" width="8" height="67"/><rect x="414" y="0" width="2" height="67"/><rect x="418" y="0" width="4" height="67"/><rect x="428" y="0" width="6" height="67"/><rect x="436" y="0" width="2" height="67"/><rect x="440" y="0" width="4" height="67"/>
              </g>
            </svg>
            <div className="text-center text-xs text-gray-700 pb-3">
              <a href="mailto:hello@comrade.money" className="hover:underline">HELLO@COMRADE.MONEY</a>
            </div>
          </div>
        </div>
        <ReceiptBottom />
      </div>
    </div>
    {showCopyToast&&<div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-6 py-3 font-bold z-50 border-2 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>COPIED TO CLIPBOARD!</div>}
  </div>
);

const Comrade = () => {
  useEffect(()=>{
    document.title="COMRADE";
    let m=document.querySelector('meta[name="description"]');
    if(!m){m=document.createElement('meta');m.name='description';document.head.appendChild(m);}
    m.content='The fairer way to split costs with friends.';
    let t=document.querySelector('meta[name="theme-color"]');
    if(!t){t=document.createElement('meta');t.name='theme-color';document.head.appendChild(t);}
    t.content='#ffd700';
  },[]);

  const formatNumber = useCallback(n=>n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),[]);
  const formatSmartNumber = useCallback(n=>{if(Math.abs(n)<0.01&&n!==0)return n.toExponential(4);return formatNumber(n.toFixed(2));},[formatNumber]);
  const getCurrencySymbol = useCallback(c=>({USD:'$',EUR:'â‚¬',GBP:'Â£'})[c]||'$',[]);
  const formatCurrency = useCallback((v,d=2,c='USD')=>`${getCurrencySymbol(c)}${formatNumber((parseFloat(v)||0).toFixed(d))}`,[formatNumber,getCurrencySymbol]);
  const formatCurrencySmart = useCallback((v,c='USD')=>`${getCurrencySymbol(c)}${formatSmartNumber(v)}`,[formatSmartNumber,getCurrencySymbol]);
  const getWeightingLabel = useCallback(w=>({none:'OFF',gentle:'LOW',standard:'MID',strong:'HIGH'})[w]||'MID',[]);
  const getWealthMetricLabel = useCallback(m=>m==='networth'?'NET WORTH':'SALARY',[]);
  const getMeasurementLabel = useCallback(m=>m==='sqm'?'SQ M':'SQ FT',[]);
  const copyToClipboard = useCallback(t=>{navigator.clipboard.writeText(t);setShowCopyToast(true);},[]);
  const navigateTo = useCallback(p=>{
    window.history.pushState({page:p},'',`#${p}`);
    setPage(p);
  },[]);

  const navigateToFaq = useCallback(()=>{
    navigateTo('about');
    setTimeout(()=>{
      const el=document.getElementById('faq-section');
      if(el) el.scrollIntoView({behavior:'smooth',block:'start'});
    },100);
  },[navigateTo]);

  useEffect(()=>{
    window.history.replaceState({page:'home'},'','#home');
    const onPop = e=>{ const p=e.state?.page||'home'; setPage(p); };
    window.addEventListener('popstate',onPop);
    return()=>window.removeEventListener('popstate',onPop);
  },[]);

  const formatTimestamp = () => {
    const d=new Date();
    const date=d.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'numeric'});
    const time=d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
    return `${date} ${time}`;
  };

  const [loadedAt,setLoadedAt] = useState(formatTimestamp);
  const [page,setPage] = useState('home');
  const [showCopyToast,setShowCopyToast] = useState(false);
  const [randomQuote,setRandomQuote] = useState('');
  const [lastQuoteIndices,setLastQuoteIndices] = useState([]);
  const [signupEmail,setSignupEmail] = useState('');
  const [signupStatus,setSignupStatus] = useState('');

  const [sharePeople,setSharePeople] = useState(()=>readStorage(SHARE_KEY)?.sharePeople||[]);
  const [shareBills,setShareBills] = useState(()=>readStorage(SHARE_KEY)?.shareBills||[]);
  const [shareWeighting,setShareWeighting] = useState(()=>readStorage(SHARE_KEY)?.shareWeighting||'standard');
  const [shareFloor,setShareFloor] = useState(()=>readStorage(SHARE_KEY)?.shareFloor||'off');
  const [shareCurrency,setShareCurrency] = useState(()=>readStorage(SHARE_KEY)?.shareCurrency||'USD');
  const [shareWealthMetric,setShareWealthMetric] = useState(()=>readStorage(SHARE_KEY)?.shareWealthMetric||'salary');
  const [hasSavedData,setHasSavedData] = useState(()=>{ const s=readStorage(SHARE_KEY); return !!(s?.sharePeople?.length||s?.shareBills?.length); });

  const [productName,setProductName] = useState(()=>readStorage(SALE_KEY)?.productName||'');
  const [numberAvailable,setNumberAvailable] = useState(()=>readStorage(SALE_KEY)?.numberAvailable||'');
  const [saleBuyers,setSaleBuyers] = useState(()=>readStorage(SALE_KEY)?.saleBuyers||[]);
  const [saleWeighting,setSaleWeighting] = useState(()=>readStorage(SALE_KEY)?.saleWeighting||'standard');
  const [saleCurrency,setSaleCurrency] = useState(()=>readStorage(SALE_KEY)?.saleCurrency||'USD');
  const [saleWealthMetric,setSaleWealthMetric] = useState(()=>readStorage(SALE_KEY)?.saleWealthMetric||'salary');
  const [hasSaleSavedData,setHasSaleSavedData] = useState(()=>{ const s=readStorage(SALE_KEY); return !!(s?.saleBuyers?.length||s?.productName); });

  const [voteDecision,setVoteDecision] = useState(()=>readStorage(VOTE_KEY)?.voteDecision||'');
  const [voteOptions,setVoteOptions] = useState(()=>readStorage(VOTE_KEY)?.voteOptions||[]);
  const [voteParticipants,setVoteParticipants] = useState(()=>readStorage(VOTE_KEY)?.voteParticipants||[]);
  const [voteWeighting,setVoteWeighting] = useState(()=>readStorage(VOTE_KEY)?.voteWeighting||'standard');
  const [voteCurrency,setVoteCurrency] = useState(()=>readStorage(VOTE_KEY)?.voteCurrency||'USD');
  const [voteWealthMetric,setVoteWealthMetric] = useState(()=>readStorage(VOTE_KEY)?.voteWealthMetric||'salary');
  const [hasVoteSavedData,setHasVoteSavedData] = useState(()=>{ const s=readStorage(VOTE_KEY); return !!(s?.voteParticipants?.length||s?.voteDecision); });

  const [totalRent,setTotalRent] = useState(()=>readStorage(RENT_KEY)?.totalRent||'');
  const [totalUtilities,setTotalUtilities] = useState(()=>readStorage(RENT_KEY)?.totalUtilities||'');
  const [rentPeople,setRentPeople] = useState(()=>readStorage(RENT_KEY)?.rentPeople||[]);
  const [rentWeighting,setRentWeighting] = useState(()=>readStorage(RENT_KEY)?.rentWeighting||'standard');
  const [rentFloor,setRentFloor] = useState(()=>readStorage(RENT_KEY)?.rentFloor||'off');
  const [rentCurrency,setRentCurrency] = useState(()=>readStorage(RENT_KEY)?.rentCurrency||'USD');
  const [rentWealthMetric,setRentWealthMetric] = useState(()=>readStorage(RENT_KEY)?.rentWealthMetric||'salary');
  const [rentMeasurement,setRentMeasurement] = useState(()=>readStorage(RENT_KEY)?.rentMeasurement||'sqft');
  const [hasRentSavedData,setHasRentSavedData] = useState(()=>{ const s=readStorage(RENT_KEY); return !!(s?.rentPeople?.length||s?.totalRent); });

  const [curPersonName,setCurPersonName] = useState('');
  const [curPersonWealth,setCurPersonWealth] = useState('');
  const [curBillDesc,setCurBillDesc] = useState('');
  const [curBillAmt,setCurBillAmt] = useState('');
  const [curBillPaidBy,setCurBillPaidBy] = useState('');
  const [shareAdvancedOpen,setShareAdvancedOpen] = useState(false);
  const [shareOpen,setShareOpen] = useState([0]);

  const [curBuyerName,setCurBuyerName] = useState('');
  const [curBuyerWealth,setCurBuyerWealth] = useState('');
  const [curBuyerOffer,setCurBuyerOffer] = useState('');
  const [saleOpen,setSaleOpen] = useState([0]);

  const [curOptionText,setCurOptionText] = useState('');
  const [curParticipantName,setCurParticipantName] = useState('');
  const [curParticipantWealth,setCurParticipantWealth] = useState('');
  const [curParticipantVote,setCurParticipantVote] = useState('');
  const [voteOpen,setVoteOpen] = useState([0]);

  const [curRoommateName,setCurRoommateName] = useState('');
  const [curRoommateRoomSize,setCurRoommateRoomSize] = useState('');
  const [curRoommateWealth,setCurRoommateWealth] = useState('');
  const [rentAdvancedOpen,setRentAdvancedOpen] = useState(false);
  const [rentOpen,setRentOpen] = useState([0]);

  const [showShareDetails,setShowShareDetails] = useState(false);
  const [showSaleDetails,setShowSaleDetails] = useState(false);
  const [showVoteDetails,setShowVoteDetails] = useState(false);
  const [showRentDetails,setShowRentDetails] = useState(false);

  useEffect(()=>{
    try {
      localStorage.setItem(SHARE_KEY,JSON.stringify({sharePeople,shareBills,shareCurrency,shareWealthMetric,shareWeighting,shareFloor,lastUpdated:Date.now()}));
      if(sharePeople.length||shareBills.length) setHasSavedData(true);
    } catch{}
  },[sharePeople,shareBills,shareCurrency,shareWealthMetric,shareWeighting,shareFloor]);

  useEffect(()=>{
    try {
      localStorage.setItem(VOTE_KEY,JSON.stringify({voteDecision,voteOptions,voteParticipants,voteCurrency,voteWealthMetric,voteWeighting,lastUpdated:Date.now()}));
      if(voteParticipants.length||voteDecision) setHasVoteSavedData(true);
    } catch{}
  },[voteDecision,voteOptions,voteParticipants,voteCurrency,voteWealthMetric,voteWeighting]);

  useEffect(()=>{
    try {
      localStorage.setItem(SALE_KEY,JSON.stringify({productName,numberAvailable,saleBuyers,saleCurrency,saleWealthMetric,saleWeighting,lastUpdated:Date.now()}));
      if(saleBuyers.length||productName) setHasSaleSavedData(true);
    } catch{}
  },[productName,numberAvailable,saleBuyers,saleCurrency,saleWealthMetric,saleWeighting]);

  useEffect(()=>{
    try {
      localStorage.setItem(RENT_KEY,JSON.stringify({totalRent,totalUtilities,rentPeople,rentCurrency,rentWealthMetric,rentWeighting,rentFloor,rentMeasurement,lastUpdated:Date.now()}));
      if(rentPeople.length||totalRent) setHasRentSavedData(true);
    } catch{}
  },[totalRent,totalUtilities,rentPeople,rentCurrency,rentWealthMetric,rentWeighting,rentFloor,rentMeasurement]);

  const makeToggle = setter => i => setter(prev=>prev.includes(i)?prev.filter(x=>x!==i):[...prev,i]);
  const makeJump = setter => i => { setter([i]); scrollToStep(i); };
  const makeCollapseToFirst = setter => () => setter([0]);

  const editModeRef = React.useRef(false);

  useEffect(()=>{
    window.scrollTo({top:0,behavior:'instant'});
    setLoadedAt(formatTimestamp());
    setShowShareDetails(false);setShowVoteDetails(false);setShowSaleDetails(false);setShowRentDetails(false);
    if(page==='share-entry') setShareOpen(editModeRef.current ? [0,1,2,3] : [0]);
    if(page==='sale-entry') setSaleOpen(editModeRef.current ? [0,1,2,3] : [0]);
    if(page==='vote-entry') setVoteOpen(editModeRef.current ? [0,1,2,3,4] : [0]);
    if(page==='rent-entry') setRentOpen(editModeRef.current ? [0,1,2,3] : [0]);
    editModeRef.current = false;
    if(['share-results','sale-results','vote-results','rent-results'].includes(page)){
      setLastQuoteIndices(prev=>{
        let idx,attempts=0;
        do{idx=Math.floor(Math.random()*QUOTES.length);attempts++;}while(prev.includes(idx)&&QUOTES.length>5&&attempts<100);
        setRandomQuote(QUOTES[idx]);
        return [...prev,idx].slice(-5);
      });
    }
  },[page]);
  useEffect(()=>{if(showCopyToast){const t=setTimeout(()=>setShowCopyToast(false),2500);return()=>clearTimeout(t);}},[showCopyToast]);

  const handleClearAll = useCallback(type=>{
    if(type==='share'){setSharePeople([]);setShareBills([]);setCurPersonName('');setCurPersonWealth('');setCurBillDesc('');setCurBillAmt('');setCurBillPaidBy('');makeCollapseToFirst(setShareOpen)();}
    if(type==='sale'){setProductName('');setNumberAvailable('');setSaleBuyers([]);setCurBuyerName('');setCurBuyerWealth('');setCurBuyerOffer('');setHasSaleSavedData(false);try{localStorage.removeItem(SALE_KEY);}catch{}makeCollapseToFirst(setSaleOpen)();}
    if(type==='vote'){setVoteDecision('');setVoteOptions([]);setVoteParticipants([]);setCurParticipantName('');setCurParticipantWealth('');setCurParticipantVote('');setCurOptionText('');setHasVoteSavedData(false);try{localStorage.removeItem(VOTE_KEY);}catch{}makeCollapseToFirst(setVoteOpen)();}
    if(type==='rent'){setTotalRent('');setTotalUtilities('');setRentPeople([]);setCurRoommateName('');setCurRoommateRoomSize('');setCurRoommateWealth('');setHasRentSavedData(false);try{localStorage.removeItem(RENT_KEY);}catch{}makeCollapseToFirst(setRentOpen)();}
    setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}),0);
  },[]);

  const loadExample = useCallback(type=>{
    const data=EXAMPLE_DATA[type];const base=Date.now();
    if(type==='share'){setSharePeople(data.people.map((p,i)=>({...p,id:base+i})));setShareBills(data.bills.map((b,i)=>({...b,id:base+100+i})));setCurPersonName('');setCurPersonWealth('');setCurBillDesc('');setCurBillAmt('');setCurBillPaidBy('');setShareOpen([0,1,2,3]);scrollToStep(1);}
    if(type==='sale'){setProductName(data.productName);setNumberAvailable(data.numberAvailable);setSaleBuyers(data.buyers.map((b,i)=>({...b,id:base+i})));setCurBuyerName('');setCurBuyerWealth('');setCurBuyerOffer('');setSaleOpen([0,1,2,3]);scrollToStep(1);}
    if(type==='vote'){setVoteDecision(data.decision);setVoteOptions(data.options.map((o,i)=>({...o,id:base+i})));setVoteParticipants(data.participants.map((p,i)=>({...p,id:base+100+i})));setCurParticipantName('');setCurParticipantWealth('');setCurParticipantVote('');setCurOptionText('');setVoteOpen([0,1,2,3,4]);scrollToStep(1);}
    if(type==='rent'){setTotalRent(data.totalRent);setTotalUtilities(data.totalUtilities);setRentPeople(data.people.map((p,i)=>({...p,id:base+i})));setCurRoommateName('');setCurRoommateRoomSize('');setCurRoommateWealth('');setRentOpen([0,1,2,3]);scrollToStep(1);}
  },[]);

  const handleEmailSignup = useCallback(e=>{
    e.preventDefault();
    try{
      const iframe=document.createElement('iframe');iframe.style.display='none';
      iframe.src=`https://script.google.com/macros/s/AKfycbxgJDAAOvTIE9Jh3dbYfIu2CBWpUiiwbRuVEPbxRlbGufF1RNL5ZWxen9Noza_eyMHu/exec?email=${encodeURIComponent(signupEmail)}`;
      document.body.appendChild(iframe);setTimeout(()=>document.body.removeChild(iframe),2000);
      setSignupStatus('success');setSignupEmail('');setTimeout(()=>setSignupStatus(''),5000);
    }catch{setSignupStatus('error');setTimeout(()=>setSignupStatus(''),5000);}
  },[signupEmail]);

  const clearStorage = useCallback(()=>{
    try { localStorage.removeItem(SHARE_KEY); } catch {}
    setSharePeople([]); setShareBills([]); setShareWeighting('standard');
    setShareFloor('off'); setShareCurrency('USD'); setShareWealthMetric('salary');
    setHasSavedData(false);
    try { localStorage.removeItem(VOTE_KEY); } catch {}
    setVoteDecision(''); setVoteOptions([]); setVoteParticipants([]);
    setVoteWeighting('standard'); setVoteCurrency('USD'); setVoteWealthMetric('salary');
    setHasVoteSavedData(false);
    try { localStorage.removeItem(SALE_KEY); } catch {}
    setProductName(''); setNumberAvailable(''); setSaleBuyers([]);
    setSaleWeighting('standard'); setSaleCurrency('USD'); setSaleWealthMetric('salary');
    setHasSaleSavedData(false);
    try { localStorage.removeItem(RENT_KEY); } catch {}
    setTotalRent(''); setTotalUtilities(''); setRentPeople([]);
    setRentWeighting('standard'); setRentFloor('off'); setRentCurrency('USD');
    setRentWealthMetric('salary'); setRentMeasurement('sqft');
    setHasRentSavedData(false);
  },[]);

  const renderAdvancedSettingsContent = ({weighting, onWeightingChange, floor, onFloorChange}) => (
    <div style={{border:`2px dashed #9CA3AF`,borderTop:'none',padding:'20px'}} className="animate-fadeIn">
      <p className="text-xs mb-5 text-black">For more information on these controls, please <span className="underline cursor-pointer hover:text-gray-600" onClick={navigateToFaq}>read our FAQ</span>. If in doubt, keep the default settings.</p>
      <h4 className="text-sm font-bold mb-1 text-black uppercase tracking-wider">WEIGHTING</h4>
      <p className="text-xs mb-3 text-black">Decide how much wealth should affect Comrade's calculations.</p>
      <WeightingButtons value={weighting} onChange={onWeightingChange}/>
      {floor !== undefined && <>
        <div className="border-t border-dashed border-gray-400 my-5"></div>
        <h4 className="text-sm font-bold mb-1 text-black uppercase tracking-wider">CONTRIBUTION FLOOR</h4>
        <p className="text-xs mb-3 text-black">If enabled, no group member pays less than the selected percentage of what they'd owe in an even split, regardless of their wealth.</p>
        <div className="flex justify-center">
          <div className="bg-gray-100 p-2 border-2 border-dotted border-black inline-block">
            <div className="flex flex-wrap gap-2">
              {[{value:'off',label:'OFF'},{value:'10',label:'10%'},{value:'25',label:'25%'},{value:'50',label:'50%'}].map(f=>(
                <button key={f.value} onClick={()=>onFloorChange(f.value)} className={`flex-1 min-w-[100px] p-3 font-bold text-xs border-2 ${floor===f.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{f.label}</button>
              ))}
            </div>
          </div>
        </div>
      </>}
    </div>
  );

  const renderWeightingSection = (weighting, onChange) => (
    <div className="mb-5">
      <h4 className="text-sm font-bold mb-1 text-black uppercase tracking-wider">WEIGHTING</h4>
      <p className="text-xs mb-3 text-black">Decide how much wealth should affect Comrade's calculations. For more information, <span className="underline cursor-pointer hover:text-gray-600" onClick={navigateToFaq}>read our FAQ</span>.</p>
      <WeightingButtons value={weighting} onChange={onChange}/>
    </div>
  );

  const lp = {onNavigate:navigateTo, showCopyToast, loadedAt, onClearStorage:clearStorage};

  const shareCalculations = useMemo(()=>{
    if(page!=='share-results'||!sharePeople.length) return{total:0,peopleData:[],transactions:[]};
    const total=shareBills.reduce((s,b)=>s+(parseFloat(b.amount)||0),0);
    const taw=sharePeople.reduce((s,pp)=>s+applyWeighting(parseFloat(pp.wealth)||0,shareWeighting),0);
    let shares=sharePeople.map(p=>{
      const w=parseFloat(p.wealth)||0,paid=shareBills.filter(b=>b.paidBy===p.name).reduce((s,b)=>s+(parseFloat(b.amount)||0),0),aw=applyWeighting(w,shareWeighting);
      const fs=taw>0?(aw/taw)*total:total/sharePeople.length;
      return{...p,wealth:w,paid,fairShare:fs,adjustedWealth:aw};
    });
    if(shareFloor!=='off'){
      const minPayment=(parseFloat(shareFloor)/100)*(total/sharePeople.length);
      let changed=true;
      while(changed){
        changed=false;
        const below=shares.filter(p=>p.fairShare<minPayment-0.001);
        if(!below.length) break;
        changed=true;
        const deficit=below.reduce((s,p)=>s+(minPayment-p.fairShare),0);
        below.forEach(p=>{p.fairShare=minPayment;});
        const above=shares.filter(p=>p.fairShare>minPayment+0.001);
        const totalAW=above.reduce((s,p)=>s+p.adjustedWealth,0);
        above.forEach(p=>{p.fairShare+=totalAW>0?(p.adjustedWealth/totalAW)*deficit:deficit/above.length;});
      }
    }
    const peopleData=shares.map(p=>({...p,paidPct:total>0?(p.paid/total)*100:0,fairPct:total>0?(p.fairShare/total)*100:0}));
    const settlements=peopleData.map(p=>({name:p.name,balance:p.paid-p.fairShare})).filter(s=>Math.abs(s.balance)>0.01);
    const payers=settlements.filter(s=>s.balance<0).sort((a,b)=>a.balance-b.balance);
    const receivers=settlements.filter(s=>s.balance>0).sort((a,b)=>b.balance-a.balance);
    const transactions=[];let pi=0,ri=0;
    const pc=payers.map(p=>({...p})),rc=receivers.map(r=>({...r}));
    while(pi<pc.length&&ri<rc.length){
      const amt=Math.min(-pc[pi].balance,rc[ri].balance);
      transactions.push({from:pc[pi].name,to:rc[ri].name,amount:amt});
      pc[pi].balance+=amt;rc[ri].balance-=amt;
      if(Math.abs(pc[pi].balance)<0.01)pi++;if(Math.abs(rc[ri].balance)<0.01)ri++;
    }
    return{total,peopleData,transactions};
  },[sharePeople,shareBills,shareWeighting,shareFloor,page]);

  const saleCalculations = useMemo(()=>{
    if(page!=='sale-results'||!saleBuyers.length) return{rankedBuyers:[],avgOffer:0};
    const rankedBuyers=saleBuyers.map(b=>{
      const w=parseFloat(b.wealth)||1,o=parseFloat(b.offer)||0,aw=applyWeighting(w,saleWeighting);
      return{...b,wealth:w,offer:o,needScore:(o/aw)*100,adjustedWealth:aw};
    }).sort((a,b)=>b.needScore-a.needScore);
    const totalOffers=rankedBuyers.reduce((s,b)=>s+b.offer,0);
    return{rankedBuyers,avgOffer:rankedBuyers.length?totalOffers/rankedBuyers.length:0};
  },[saleBuyers,saleWeighting,page]);

  const voteCalculations = useMemo(()=>{
    if(page!=='vote-results'||!voteParticipants.length) return{participantsData:[],totalVotingPower:0,voteBreakdown:[]};
    const totalW=voteParticipants.reduce((s,p)=>s+(parseFloat(p.wealth)||0),0),avgW=totalW/voteParticipants.length;
    const participantsData=voteParticipants.map(p=>{
      const w=parseFloat(p.wealth)||0,aw=applyWeighting(w,voteWeighting),vp=aw>0?avgW/aw:1;
      return{...p,wealth:w,votingPower:vp,adjustedWealth:aw};
    });
    const totalVP=participantsData.reduce((s,p)=>s+p.votingPower,0);
    const voteBreakdown=voteOptions.map(opt=>{
      const voters=participantsData.filter(p=>p.vote===opt.text),pwr=voters.reduce((s,p)=>s+p.votingPower,0);
      return{option:opt.text,percentage:totalVP>0?(pwr/totalVP)*100:0,voters};
    }).sort((a,b)=>b.percentage-a.percentage);
    return{participantsData,totalVotingPower:totalVP,voteBreakdown};
  },[voteParticipants,voteOptions,voteWeighting,page]);

  const rentCalculations = useMemo(()=>{
    if(page!=='rent-results'||!rentPeople.length) return{rentAmount:0,utilitiesAmount:0,total:0,totalRoomSize:0,rentData:[],totalRoomValue:0};
    const rentAmount=parseFloat(totalRent)||0,utilitiesAmount=parseFloat(totalUtilities)||0,total=rentAmount+utilitiesAmount;
    const trs=rentPeople.reduce((s,p)=>s+(parseFloat(p.roomSize)||0),0);
    const pd=rentPeople.map(p=>{
      const rs=parseFloat(p.roomSize)||0,w=parseFloat(p.wealth)||0,rp=trs>0?(rs/trs)*100:0,aw=applyWeighting(w,rentWeighting);
      return{...p,roomSize:rs,wealth:w,roomPct:rp,adjustedWealth:aw,roomValue:rp*aw};
    });
    const trv=pd.reduce((s,p)=>s+p.roomValue,0);
    let shares=pd.map(p=>({...p,fairRent:trv>0?(p.roomValue/trv)*total:total/rentPeople.length}));
    if(rentFloor!=='off'){
      const minPayment=(parseFloat(rentFloor)/100)*(total/rentPeople.length);
      let changed=true;
      while(changed){
        changed=false;
        const below=shares.filter(p=>p.fairRent<minPayment-0.001);
        if(!below.length) break;
        changed=true;
        const deficit=below.reduce((s,p)=>s+(minPayment-p.fairRent),0);
        below.forEach(p=>{p.fairRent=minPayment;});
        const above=shares.filter(p=>p.fairRent>minPayment+0.001);
        const totalRV=above.reduce((s,p)=>s+p.roomValue,0);
        above.forEach(p=>{p.fairRent+=totalRV>0?(p.roomValue/totalRV)*deficit:deficit/above.length;});
      }
    }
    const rentData=shares.map(p=>({...p,rentPct:total>0?(p.fairRent/total)*100:100/rentPeople.length})).sort((a,b)=>b.fairRent-a.fairRent);
    return{rentAmount,utilitiesAmount,total,totalRoomSize:trs,rentData,totalRoomValue:trv};
  },[rentPeople,totalRent,totalUtilities,rentWeighting,rentFloor,page]);

  const MotivationalQuote = () => <p className="text-center text-gray-700 leading-relaxed text-xs">{randomQuote}</p>;

  const renderEmailSignup = () => (
    <div className="bg-white p-6 border-2 border-dashed border-gray-400">
      <h3 className="text-lg font-bold text-black uppercase tracking-wider text-center mb-2">LIKE COMRADE?</h3>
      <p className="text-xs text-black text-center mb-4">Get updates and news from the team.</p>
      {signupStatus==='success'
        ?<div className="p-4 text-center font-bold border-2 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>THANKS FOR SIGNING UP!</div>
        :signupStatus==='error'
          ?<div className="bg-white text-black p-4 text-center font-bold border-2 border-black">ERROR - PLEASE TRY AGAIN</div>
          :<div className="flex flex-col sm:flex-row gap-2 max-w-md mx-auto">
            <FormInput type="email" value={signupEmail} onChange={e=>setSignupEmail(e.target.value)} placeholder="YOUR EMAIL" className="flex-1"/>
            <button onClick={handleEmailSignup} className="bg-black text-white px-6 py-2 font-bold border-2 border-black hover:bg-gray-800 transition-all">+ SIGN UP</button>
          </div>
      }
    </div>
  );

  const renderNoDataState = entryPage => (
    <div className="bg-white p-6 border-2 border-solid border-black mb-6">
      <div className="flex items-center gap-2 mb-2"><ErrorIcon/><p className="text-black font-bold sf">ERROR!</p></div>
      <p className="text-black text-xs mt-1">Missing or incomplete data. Go back and check your information.</p>
      <div className="mt-4"><button onClick={()=>navigateTo(entryPage)} className="bg-black text-white px-6 py-2 font-bold border-2 border-black w-full max-w-xs">GO BACK</button></div>
    </div>
  );

  const renderResultsNavigation = (copyText, entryPage) => (
    <div className="flex flex-col gap-3 max-w-xs mx-auto">
      <button onClick={()=>copyToClipboard(copyText)} className="bg-black text-white px-6 py-2 font-bold border-2 border-black hover:bg-gray-800 transition-all w-full">COPY RESULTS</button>
      <button onClick={()=>{editModeRef.current=true;navigateTo(entryPage);}} className="bg-black text-white px-6 py-2 font-bold border-2 border-black hover:bg-gray-800 transition-all w-full">EDIT DETAILS</button>
      <button onClick={()=>navigateTo('home')} className="bg-gray-200 text-black px-6 py-2 font-bold border-2 border-gray-400 hover:bg-gray-300 transition-all w-full">RETURN HOME</button>
    </div>
  );

  const renderResultsFooter = (hasData, copyText, entryPage) => hasData && (
    <>
      {renderResultsNavigation(copyText, entryPage)}

      <div className="my-4 text-center py-6"><MotivationalQuote /></div>
      <div className="mt-4">{renderEmailSignup()}</div>
    </>
  );

  const renderWealthPieChart = data => {
    const sorted=[...data].sort((a,b)=>b.wealth-a.wealth);
    const total=sorted.reduce((s,p)=>s+p.wealth,0);
    const colors=['#000000','#1F2937','#475569','#64748B','#94A3B8','#CBD5E1','#E2E8F0','#F1F5F9'];
    return(
      <>
        <svg viewBox="0 0 200 200" className="w-full max-w-xs mx-auto">
          {(()=>{let cur=0;return sorted.map((p,idx)=>{
            const pct=total>0?(p.wealth/total):(1/sorted.length),angle=pct*360,cx=100,cy=100,r=70,ir=30;
            const s1=((cur-90)*Math.PI/180),e1=((cur+angle-90)*Math.PI/180);
            const x1=cx+r*Math.cos(s1),y1=cy+r*Math.sin(s1),x2=cx+r*Math.cos(e1),y2=cy+r*Math.sin(e1);
            const x3=cx+ir*Math.cos(e1),y3=cy+ir*Math.sin(e1),x4=cx+ir*Math.cos(s1),y4=cy+ir*Math.sin(s1);
            const la=angle>180?1:0;
            const d=`M${x1} ${y1} A${r} ${r} 0 ${la} 1 ${x2} ${y2} L${x3} ${y3} A${ir} ${ir} 0 ${la} 0 ${x4} ${y4} Z`;
            cur+=angle;
            return <path key={idx} d={d} fill={colors[idx%colors.length]} stroke={BG_GREY} strokeWidth="1"/>;
          });})()}
        </svg>
        <div className="mt-6 space-y-2">
          {sorted.map((p,idx)=>{
            const pct=total>0?(p.wealth/total)*100:100/sorted.length;
            return(
              <div key={idx} className="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-black">
                <div className="w-4 h-4 border border-gray-400 flex-shrink-0" style={{backgroundColor:colors[idx%colors.length]}}></div>
                <span className="font-bold text-black">{p.name}</span>
                <span className="text-black">${formatNumber(p.wealth.toFixed(2))}</span>
                <span className="font-bold text-black">({pct.toFixed(1)}%)</span>
              </div>
            );
          })}
        </div>
      </>
    );
  };

  const renderBarVisualization = (title,data,bars,getItemName) => (
    <div className="mb-6">
      <h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">{title}</h3>
      <div className="space-y-3">
        {data.map((item,idx)=>{
          const maxV=Math.max(...data.map(d=>Math.max(...bars.map(b=>b.getValue(d)))));
          return(
            <div key={item.id||idx} className="mb-4">
              <p className="font-bold text-black mb-1 text-xs uppercase">{getItemName(item)}</p>
              <div className="space-y-1">
                {bars.map((bar,bi)=>{
                  const v=bar.getValue(item),w=maxV>0?(v/maxV)*100:0;
                  return(
                    <div key={bi} className="flex items-center gap-2">
                      {bar.label&&<span className="text-xs text-black w-20 font-bold">{bar.label}:</span>}
                      <div className="flex-1 bg-gray-200 h-6 relative overflow-hidden border border-gray-400">
                        <div className="h-6 bar-animate flex items-center justify-end pr-2 sf" style={{width:`${w}%`,animationDelay:`${idx*0.1+bi*0.05}s`,backgroundColor:DARK}}>
                          {w>15&&<span className="text-xs font-bold" style={{color:BG_GREY}}>{bar.displayValue(item)}</span>}
                        </div>
                      </div>
                      <span className="text-xs font-bold text-black w-24 text-right">{bar.rightLabel(item,idx)}</span>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  const renderMathRow = (data,getFormula) => data.map(p=>(
    <div key={p.id} className="flex justify-between mb-1"><span>{p.name}:</span><span className="font-mono">{getFormula(p)}</span></div>
  ));
  const renderAdjustedWealthStep = (num,data,weighting) => (
    <div>
      <p className="font-bold mb-2">{num}. ADJUSTED WEALTH ({getWeightingLabel(weighting).toUpperCase()}):</p>
      {renderMathRow(data,p=>{
        if(weighting==='gentle') return `âˆš${formatNumber(p.wealth.toFixed(0))} = ${formatNumber(p.adjustedWealth.toFixed(2))}`;
        if(weighting==='standard') return formatNumber(p.wealth.toFixed(2));
        if(weighting==='strong') return `${formatNumber(p.wealth.toFixed(0))}Â² = ${formatSmartNumber(p.adjustedWealth)}`;
        return '';
      })}
    </div>
  );
  const renderMathSection = (weighting,weightedSteps,noWeightingContent) => (
    <div className="mb-6">
      <h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">THE MATH</h3>
      <div className="bg-white p-6 border-2 border-gray-400">
        <div className="space-y-3 text-xs text-black">
          {weighting!=='none'
            ?weightedSteps.map((step,i)=><React.Fragment key={i}>{i>0&&<div className="border-t-2 border-dashed border-gray-400 my-3"></div>}{step}</React.Fragment>)
            :noWeightingContent
          }
        </div>
      </div>
    </div>
  );
  const renderDetailCards = (title,data,getCardConfig) => (
    <div className="mb-6">
      <h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">{title}</h3>
      <div className="space-y-3">
        {data.map((item,idx)=>{
          const cfg=getCardConfig(item,idx);
          return(
            <div key={item.id||idx} className={cfg.cardClassName||"bg-white p-4 border-2 border-gray-400"}>
              {cfg.titleExtra
                ?<div className="flex justify-between items-start mb-3 border-b border-dashed border-gray-400 pb-2"><p className="font-bold text-sm text-black uppercase">{cfg.name}</p>{cfg.titleExtra}</div>
                :<p className="font-bold text-sm text-black mb-3 uppercase border-b border-dashed border-gray-400 pb-2">{cfg.name}</p>
              }
              <div className="space-y-2 text-xs text-black">
                {cfg.rows.map((r,i)=><div key={i} className="flex justify-between"><span className="text-black font-bold">{r.label}:</span><span className="font-semibold text-black">{r.value}</span></div>)}
                {cfg.summaryRows&&cfg.summaryRows.map((r,i)=>(
                  <div key={`s${i}`} className={`flex justify-between ${i===0?'pt-2 border-t border-dashed border-gray-400':''}`}>
                    <span className="text-black font-bold">{r.label}:</span>
                    <span className={r.className||"font-black text-black"}>{r.value}</span>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  const NavButton = ({label,onClick}) => (
    <button onClick={onClick} className="bg-black text-white w-full py-3 font-bold border-2 border-black text-sm hover:bg-gray-800 transition-all mt-2">{label}</button>
  );

  const AdvancedSettingsToggle = ({isOpen, onToggle}) => (
    <button onClick={onToggle} style={{background:isOpen?DARK:'transparent',border:isOpen?`2px solid ${DARK}`:'2px dashed #9CA3AF',display:'flex',alignItems:'center',padding:'16px',width:'100%',cursor:'pointer',transition:'background 0.15s'}}>
      <span style={{width:16,flexShrink:0}}/>
      <span style={{flex:1,textAlign:'center',fontWeight:900,fontSize:'1.25rem',textTransform:'uppercase',color:isOpen?BG_GREY:DARK,lineHeight:1.2}}>ADVANCED SETTINGS</span>
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style={{flexShrink:0,transition:'transform 0.2s',transform:isOpen?'rotate(180deg)':'rotate(0deg)'}}>
        <polyline points="2,5 8,11 14,5" stroke={isOpen?BG_GREY:'#9CA3AF'} strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    </button>
  );

  const HomeAccordion = () => {
    const [openSection,setOpenSection] = useState(null);
    const toggle = key => setOpenSection(prev=>prev===key?null:key);
    const Chevron = ({open}) => (
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style={{flexShrink:0,transition:'transform 0.2s',transform:open?'rotate(180deg)':'rotate(0deg)'}}>
        <polyline points="2,5 8,11 14,5" stroke={open?BG_GREY:'#9CA3AF'} strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"/>
      </svg>
    );
    const sectionBtn = (key,label) => {
      const isOpen=openSection===key;
      return (
        <button onClick={()=>toggle(key)} style={{background:isOpen?DARK:'transparent',border:isOpen?`2px solid ${DARK}`:'2px dashed #9CA3AF',display:'flex',alignItems:'center',justifyContent:'space-between',padding:'16px',width:'100%',cursor:'pointer',transition:'background 0.15s'}}>
          <span style={{flex:1,textAlign:'center',fontWeight:900,fontSize:'1.25rem',textTransform:'uppercase',color:isOpen?BG_GREY:DARK,lineHeight:1.2}}>{label}</span>
          <Chevron open={isOpen}/>
        </button>
      );
    };
    return (
      <div style={{display:'flex',flexDirection:'column',gap:'12px',maxWidth:'448px',margin:'0 auto'}}>
        <button onClick={()=>navigateTo('share-entry')} className="w-full bg-black text-white font-bold py-4 px-6 border-2 border-black hover:bg-gray-800 transition-all text-xl">GET STARTED</button>
        <div>
          {sectionBtn('how','HOW IT WORKS')}
          {openSection==='how'&&(
            <div style={{border:'2px dashed #9CA3AF',borderTop:'none',padding:'20px'}}>
              <div className="space-y-6">
                <div className="flex gap-4 items-start">
                  <div className="font-black text-4xl w-16 h-16 flex items-center justify-center border-2 flex-shrink-0 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>1</div>
                  <div><h3 className="font-bold text-black uppercase mb-1">ADD YOUR GROUP</h3><p className="text-xs text-black">Enter everyone's names, and incomes or net worth</p></div>
                </div>
                <PeopleAvatars />
                <div className="flex gap-4 items-start">
                  <div className="font-black text-4xl w-16 h-16 flex items-center justify-center border-2 flex-shrink-0 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>2</div>
                  <div><h3 className="font-bold text-black uppercase mb-1">ENTER YOUR BILLS</h3><p className="text-xs text-black">List what was spent, and who paid</p></div>
                </div>
                <MockReceipt />
                <div className="flex gap-4 items-start">
                  <div className="font-black text-4xl w-16 h-16 flex items-center justify-center border-2 flex-shrink-0 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>3</div>
                  <div><h3 className="font-bold text-black uppercase mb-1">GET FAIR RESULTS</h3><p className="text-xs text-black">See who owes what, based on ability to pay</p></div>
                </div>
                <ResultPieChart />
              </div>
              <div className="mt-6 flex flex-col max-w-xs mx-auto" style={{gap:'12px'}}>
                <button onClick={()=>navigateTo('about')} className="w-full font-bold py-4 px-8 border-2 border-black hover:bg-gray-100 transition-all text-lg" style={{background:BG_GREY,color:DARK}}>LEARN MORE</button>
                <button onClick={()=>navigateTo('share-entry')} className="w-full bg-black text-white font-bold py-4 px-8 border-2 border-black hover:bg-gray-800 transition-all text-lg">TRY IT NOW</button>
              </div>
            </div>
          )}
        </div>
        <div style={{textAlign:'center',marginTop:4}}>
          <span onClick={()=>navigateTo('tools')} style={{fontSize:'14px',color:'#6B7280',letterSpacing:'1px',cursor:'pointer',borderBottom:'1px dashed #6B7280',paddingBottom:'1px',display:'inline-block'}}>SEE ALL TOOLS â†’</span>
        </div>
      </div>
    );
  };

  if(page==='home') return (
    <Layout {...lp}>
      <p className="text-center text-sm mb-4 text-black leading-relaxed font-bold">THE FAIRER WAY TO SPLIT COSTS WITH FRIENDS.</p>
      <p className="text-center text-sm mb-4 text-black leading-relaxed">COMRADE COMBINES AND SIMPLIFIES GROUP BILLS â€” THEN DIVIDES THEM BASED ON WEALTH.</p>
      <HomeAccordion />
    </Layout>
  );

  if(page==='tools') {
    const tools=[
      {route:'share-entry',icon:<BillIcon size={22}/>,label:'SPLITTING BILLS?'},
      {route:'rent-entry',icon:<HouseIcon size={22}/>,label:'SPLITTING RENT?'},
      {route:'sale-entry',icon:<TagIcon size={22}/>,label:'SELLING SOMETHING?'},
      {route:'vote-entry',icon:<CheckCircleIcon size={22}/>,label:'VOTING ON A DECISION?',experimental:true},
    ];
    return (
      <Layout {...lp}>
        <div style={{display:'flex',justifyContent:'space-around',alignItems:'center',marginTop:28,marginBottom:28,padding:'0 8px'}}>
          {tools.map(t=><div key={t.route}>{t.icon}</div>)}
        </div>
        <p className="text-sm text-black text-center mb-6">COMRADE BUILDS PRODUCTS THAT MAKE LIFE FAIRER. CHOOSE FROM OUR FULL LIST OF TOOLS BELOW.</p>
        <div style={{maxWidth:'448px',margin:'0 auto'}}>
          {tools.map(t=>(
            <div key={t.route} style={{marginBottom:12}}>
              <button onClick={()=>navigateTo(t.route)} className="w-full border-2 border-black hover:opacity-80 transition-all" style={{background:t.route==='share-entry'?DARK:BG_GREY,padding:'16px 20px',flexDirection:'column',gap:2}}>
                {t.experimental&&<span style={{fontSize:'10px',color:t.route==='share-entry'?'#ccc':'#9CA3AF',letterSpacing:'2px',fontWeight:900,textAlign:'center',display:'block'}}>EXPERIMENTAL</span>}
                <span style={{fontSize:'17px',letterSpacing:'1px',color:t.route==='share-entry'?BG_GREY:DARK,display:'block',textAlign:'center',fontWeight:900}}>{t.label}</span>
              </button>
            </div>
          ))}
        </div>
      </Layout>
    );
  }

  if(page==='about') return (
    <Layout {...lp}>
      <h2 className="text-2xl font-black mb-4 text-black uppercase tracking-wider text-center">ABOUT</h2>
      <AboutBanner />
      <div className="space-y-4 text-black mb-4">
        <p className="leading-relaxed text-xs">If a banker, a nurse, and a student go out for dinner, how should they split the bill?</p>
        <p className="leading-relaxed text-xs">Just ask Comrade.</p>
        <p className="leading-relaxed text-xs">Comrade is an app that takes the awkwardness out of group expenses. From vacations to household purchases to work drinks, it simplifies shared bills and divides them fairly â€” by taking into account people's wealth (salaries or net worth) to decide the split. Those who have more, pay more.</p>
        <p className="leading-relaxed text-xs">Wealth isn't evenly distributed. Costs shouldn't be either. So next time your friends, family, or coworkers need to split the check, use Comrade for a fairer way to settle up.</p>
        <p className="leading-relaxed text-xs">Beyond <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>navigateTo('share-entry')}>bill-splitting</span>, Comrade offers a number of other features. There is a tool to help decide <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>navigateTo('rent-entry')}>rent splits</span> in apartments more fairly, another to assist when <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>navigateTo('sale-entry')}>selling</span> an item to ensure the buyer is the person who values it most highly, and an experimental tool for <span className="underline cursor-pointer hover:text-gray-600" onClick={()=>navigateTo('vote-entry')}>voting</span> on decisions.</p>
      </div>
      <div className="mb-4">{renderEmailSignup()}</div>
      <CurrencyDivider />
      <div>
        <h2 id="faq-section" className="text-2xl font-black py-4 text-black uppercase tracking-wider text-center border-b-2 border-dashed border-gray-400">FAQ</h2>
        {[
          {q:'HOW DOES THIS WORK?',a:'Comrade uses wealth data to decide how much each person should pay. It combines all the bills and the amounts already paid, then looks at each person\'s wealth in relation to others in the group to establish what proportion of the total amount each person should actually be responsible for.'},
          {q:'WHAT DO YOU DO WITH MY FINANCIAL INFORMATION?',render:<><p className="leading-relaxed text-xs mb-3">Nothing.</p><p className="leading-relaxed text-xs mb-3">Calculations are performed by your device, and your data is only stored locally. It is never sent to Comrade, and is automatically wiped after 30 days of inactivity.</p><p className="leading-relaxed text-xs">If a user signs up for email updates, their email is shared with Comrade only, and is not associated with any financial data.</p></>},
          {q:'WHO BUILT THIS?',render:<p className="leading-relaxed text-xs">Comrade is a startup based in Brooklyn, New York. Get in touch at <a href="mailto:hello@comrade.money" className="underline hover:text-gray-600">hello@comrade.money</a>.</p>},
          {q:'WHAT IS "WEIGHTING"?',a:'Weighting is the level of emphasis placed on each user\'s relative wealth (salary/net worth). By default, each person\'s responsibility is directly correlated with their wealth.\n\nFor example, let\'s say Fred and George each paid $100 on shared bills. Fred earns $50,000 a year, while George brings in $100,000. With regular ("Mid") weighting, because George makes twice as much money as Fred, he should pay twice as much. So far, he only paid 50% â€” $100 â€” meaning he owes Fred another $33.33.\n\nIn settings, you can also select "High" weighting, which emphasizes wealth differences even more by using squared wealth values for calculations; or "Low" weighting, which uses square-root values for more gentle adjustments. There is also an option to forego weighting entirely.'},
          {q:'WHAT IS A "CONTRIBUTION FLOOR"?',a:'A contribution floor sets a minimum amount that any group member must pay, regardless of their wealth. It\'s expressed as a percentage of what they\'d owe in an even split.\n\nFor example, if three people are splitting $300 and the floor is set to 25%, no one pays less than $25 â€” that\'s 25% of an equal $100 share. Wealthier members absorb the difference.\n\nBy default, the contribution floor is deactivated.'},
          {q:'IS COMRADE AVAILABLE ON THE APP STORE?',render:<p className="leading-relaxed text-xs">Not yet! For now, Comrade is fully functional on mobile and desktop via our website, <a href="https://www.comrade.money" target="_blank" rel="noopener noreferrer" className="underline hover:text-gray-600">www.comrade.money</a>. If you'd like to use a standalone app, or have other feedback or feature requests, please get in touch.</p>},
          {q:"IT'S AWKWARD ASKING MY FRIENDS HOW MUCH MONEY THEY HAVE. WHAT SHOULD I DO?",render:<p className="leading-relaxed text-xs">Do it anyway.{' '}<a href="https://www.hbs.edu/ris/Publication%20Files/23-039_f20d86a0-a1cf-4bd6-8066-74ccc6f2c3cf.pdf" target="_blank" rel="noopener noreferrer" className="underline hover:text-gray-600">Studies</a>{' '}have found{' '}<a href="https://www.nytimes.com/interactive/2020/02/19/magazine/salary-sharing.html" target="_blank" rel="noopener noreferrer" className="underline hover:text-gray-600">breaking</a>{' '}the{' '}<a href="https://www.businessinsider.com/salary-pay-transparency-jobs-income-taboo-equity-2023-1" target="_blank" rel="noopener noreferrer" className="underline hover:text-gray-600">taboos</a>{' '}around sharing information about wealth makes society better.</p>},
          {q:'IS THIS SERIOUS?',a:'What do you think?'},
        ].map((item,i,arr)=><FaqItem key={item.q} {...item} border={i<arr.length-1}/>)}
      </div>
    </Layout>
  );

  if(page==='legal') return (
    <Layout {...lp}>
      <h2 className="text-2xl font-black mb-4 text-black uppercase tracking-wider text-center">LEGAL</h2>
      <div className="text-black">
        {['All calculations are performed locally on your device. Any financial information entered into the application is stored only on your device and is never transmitted to Comrade. It is automatically wiped after 30 days of inactivity.',
          'This application is provided for informational purposes only. Users are solely responsible for their own actions. The creators of Comrade are not liable for any outcomes, disputes, unintended consequences, or bad decisions resulting from the use of Comrade and its calculations. Sorry!',
          'By entering your email address, you consent to Comrade and its team contacting you about updates to the app, news, and other projects they may be working on. Comrade will not sell your personal information to third parties.',
          'This application is available under a Creative Commons Attribution-NonCommercial 4.0 International License (CC BY-NC 4.0).'
        ].map((t,i,arr)=>(
          <React.Fragment key={i}>
            {i>0&&<div className="border-t-2 border-dashed border-gray-400 my-4"/>}
            <p className="leading-relaxed text-xs">{t}</p>
          </React.Fragment>
        ))}
      </div>
    </Layout>
  );

  if(page==='share-entry'){
    const steps=[{label:'SPLIT COSTS',icon:<BillIcon size={22}/>},{label:'PEOPLE',icon:<PersonIcon size={22}/>},{label:'BILLS',icon:<BillIcon size={22}/>},{label:'CALCULATE',icon:<CalculateIcon size={22}/>}];
    const jump=makeJump(setShareOpen);
    const renderContent=i=>{
      if(i===0) return (
        <div>
          <p className="text-xs mb-5 text-black">From meals to vacations, taxis to tickets, handle your shared expenses with friends more fairly. Comrade combines and simplifies group bills, while using information about group members' finances to decide how much everyone should pay.</p>
          <div className="flex flex-col gap-3">
            {hasSavedData ? (
              <>
                <button onClick={()=>jump(1)} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">RESUME SPLIT â†’</button>
                <div className="flex gap-3">
                  <button onClick={()=>loadExample('share')} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
                  <button onClick={()=>{handleClearAll('share');jump(1);}} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">NEW SPLIT</button>
                </div>
              </>
            ) : (
              <>
                <button onClick={()=>{handleClearAll('share');jump(1);}} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">NEW SPLIT â†’</button>
                <button onClick={()=>loadExample('share')} className="w-full bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
              </>
            )}
          </div>
        </div>
      );
      if(i===1) return (
        <div>
          <p className="text-xs mb-4 text-black">List the people splitting the costs, including their financial resources.</p>
          <div className="border-2 border-dashed border-gray-400 p-4 mb-5">
            <p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">CURRENCY:</p>
            <div className="flex justify-center mb-4">
              <div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block">
                <div className="flex gap-1">
                  {[{value:'USD',label:'$'},{value:'EUR',label:'â‚¬'},{value:'GBP',label:'Â£'}].map(c=>(
                    <button key={c.value} onClick={()=>setShareCurrency(c.value)} className={`px-4 py-2 font-bold text-xs border-2 ${shareCurrency===c.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{c.label}</button>
                  ))}
                </div>
              </div>
            </div>
            <div className="border-t border-dashed border-gray-400 my-3"></div>
            <p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">WEALTH METRIC:</p>
            <div className="flex justify-center">
              <div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block">
                <div className="flex gap-1">
                  {[{value:'salary',label:'SALARY'},{value:'networth',label:'NET WORTH'}].map(w=>(
                    <button key={w.value} onClick={()=>setShareWealthMetric(w.value)} className={`px-3 py-2 font-bold text-xs border-2 ${shareWealthMetric===w.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{w.label}</button>
                  ))}
                </div>
              </div>
            </div>
          </div>
          <div className="flex flex-col sm:flex-row gap-2 mb-3">
            <FormInput value={curPersonName} onChange={e=>setCurPersonName(e.target.value)} placeholder="NAME" className="flex-1" style={{minWidth:'140px'}}/>
            <FormInput type="number" value={curPersonWealth} onChange={e=>setCurPersonWealth(e.target.value)} placeholder={`${getCurrencySymbol(shareCurrency)} ${getWealthMetricLabel(shareWealthMetric)}`} min="0" step="0.01" inputMode="decimal" className="flex-1" style={{minWidth:'180px'}}/>
          </div>
          <button onClick={()=>{if(curPersonName.trim()){setSharePeople([...sharePeople,{id:Date.now(),name:curPersonName,wealth:curPersonWealth}]);setCurPersonName('');setCurPersonWealth('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD PERSON</button>
          {sharePeople.length>0
            ?<ItemList items={sharePeople} onDelete={id=>setSharePeople(sharePeople.filter(p=>p.id!==id))} renderItem={p=><><p className="text-xs text-black font-bold uppercase">{p.name}</p><p className="text-xs text-black">{getWealthMetricLabel(shareWealthMetric)}: {formatCurrency(p.wealth,2,shareCurrency)}</p></>}/>
            :<p className="text-center text-gray-600 uppercase tracking-wider font-bold mt-2" style={{fontSize:'10px'}}>â€” No people added yet â€”</p>
          }
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(2)}/></div>
        </div>
      );
      if(i===2) return (
        <div>
          <p className="text-xs mb-4 text-black">Add all the expenses the group is splitting, along with who already paid for what.</p>
          <FormInput value={curBillDesc} onChange={e=>setCurBillDesc(e.target.value)} placeholder="DESCRIPTION" className="w-full mb-2"/>
          <div className="flex flex-col sm:flex-row gap-2 mb-3">
            <FormInput type="number" value={curBillAmt} onChange={e=>setCurBillAmt(e.target.value)} placeholder={`${getCurrencySymbol(shareCurrency)} AMOUNT`} min="0" step="0.01" inputMode="decimal" className="flex-1" style={{minWidth:'150px'}}/>
            <select value={curBillPaidBy} onChange={e=>setCurBillPaidBy(e.target.value)} className="flex-1 p-2 border-2 border-gray-400 bg-white uppercase" style={{minWidth:'150px',fontSize:'16px',height:'42px'}}>
              <option value="">WHO PAID?</option>
              {sharePeople.map((p,j)=><option key={p.id||j} value={p.name}>{p.name}</option>)}
            </select>
          </div>
          <button onClick={()=>{if(curBillDesc.trim()){setShareBills([...shareBills,{id:Date.now(),description:curBillDesc,amount:curBillAmt,paidBy:curBillPaidBy}]);setCurBillDesc('');setCurBillAmt('');setCurBillPaidBy('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD BILL</button>
          {shareBills.length>0
            ?<ItemList items={shareBills} onDelete={id=>setShareBills(shareBills.filter(b=>b.id!==id))} renderItem={b=><><p className="text-black font-bold uppercase">{b.description}</p><p className="text-black text-xs">{b.paidBy||'Unknown'}</p></>} receiptStyle formatTotal={t=>formatCurrency(t,2,shareCurrency)} getAmount={b=>b.amount}/>
            :<><p className="text-center text-gray-600 uppercase tracking-wider font-bold mb-4" style={{fontSize:'10px'}}>â€” No bills added yet â€”</p><div className="flex justify-between items-center pt-3 border-t-2 border-black"><span className="font-black text-black uppercase sf">TOTAL</span><span className="font-black text-black text-lg sf">{formatCurrency(0,2,shareCurrency)}</span></div></>
          }
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(3)}/></div>
        </div>
      );
      return (
        <div>
          <p className="text-xs mb-5 text-black">Tweak any settings, or just see your results.</p>
          <div className="mb-3">
            <AdvancedSettingsToggle isOpen={shareAdvancedOpen} onToggle={()=>setShareAdvancedOpen(o=>!o)}/>
            {shareAdvancedOpen&&renderAdvancedSettingsContent({weighting:shareWeighting,onWeightingChange:setShareWeighting,floor:shareFloor,onFloorChange:setShareFloor})}
          </div>
          <button onClick={()=>navigateTo('share-results')} className="bg-black text-white w-full py-4 font-black text-xl border-4 border-black hover:bg-gray-800 transition-all uppercase calculate-btn">CALCULATE</button>
        </div>
      );
    };
    return <Layout {...lp}><AccordionPage steps={steps} openIndices={shareOpen} onToggle={makeToggle(setShareOpen)} renderContent={renderContent}/></Layout>;
  }

  if(page==='share-results'){
    const {total,peopleData,transactions}=shareCalculations;
    const hasOrphaned=shareBills.some(b=>!b.paidBy||!sharePeople.some(p=>p.name===b.paidBy));
    const hasData=sharePeople.length>0&&shareBills.length>0&&shareBills.some(b=>parseFloat(b.amount)>0)&&!hasOrphaned;
    return (
      <Layout {...lp}>
        {!hasData&&renderNoDataState('share-entry')}
        {hasData&&(<>
          <div className="p-8 mb-4 border-4 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>
            <h3 className="text-xl font-black mb-4 uppercase tracking-wider pb-2" style={{borderBottom:`2px solid ${BG_GREY}`}}>YOUR SETTLEMENT</h3>
            {transactions.length===0?<p className="text-lg font-bold">ALL SETTLED! EVERYONE'S SQUARE.</p>:<div className="space-y-3">{transactions.map((t,i)=><div key={i} className="text-sm leading-relaxed pb-2" style={{borderBottom:`1px dashed ${BG_GREY}`}}><span className="font-semibold">{t.from.toUpperCase()}</span><span> PAYS </span><span className="font-semibold">{t.to.toUpperCase()}</span><br/><span className="font-black text-2xl">{formatCurrencySmart(t.amount,shareCurrency)}</span></div>)}</div>}
            <BlackBoxStats stats={[{label:'TOTAL BILLS',value:shareBills.length},{label:'TOTAL',value:formatCurrency(total,2,shareCurrency)},{label:'PEOPLE',value:sharePeople.length},{label:'WEIGHTING',value:getWeightingLabel(shareWeighting)}]}/>
          </div>
          <DetailToggleButton show={showShareDetails} onClick={()=>setShowShareDetails(!showShareDetails)}/>
          {showShareDetails&&<div className="animate-fadeIn">
            {renderDetailCards('PARTICIPANT DATA',[...peopleData].sort((a,b)=>b.wealth-a.wealth),p=>{const bal=p.paid-p.fairShare;return{name:p.name,rows:[{label:'WEALTH',value:formatCurrency(p.wealth,2,shareCurrency)},{label:'PAID',value:`${formatCurrency(p.paid,2,shareCurrency)} (${p.paidPct.toFixed(1)}%)`},{label:'FAIR SHARE',value:`${formatCurrencySmart(p.fairShare,shareCurrency)} (${p.fairPct.toFixed(1)}%)`}],summaryRows:[{label:'BALANCE',value:`${bal>0.01?'+':''}${formatCurrencySmart(bal,shareCurrency)}`}]};})}
            <DashedDivider/>
            <div className="mb-6">
              <h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">BILL RECAP</h3>
              <div className="space-y-3 mb-4">{shareBills.map((b,i)=><div key={b.id||i} className="flex justify-between items-start text-xs text-black border-b border-dashed border-gray-400 pb-2"><div className="flex-1"><p className="font-bold text-black uppercase">{b.description}</p><p className="text-black text-xs">{b.paidBy||'Unknown'}</p></div><span className="font-bold text-black ml-4">{formatCurrency(b.amount,2,shareCurrency)}</span></div>)}</div>
              <div className="flex justify-between items-center pt-3 border-t-2 border-black"><span className="font-black text-black uppercase sf">TOTAL</span><span className="font-black text-black text-lg sf">{formatCurrency(total,2,shareCurrency)}</span></div>
            </div>
            <DashedDivider/>
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">WEALTH VISUALIZATION</h3>{renderWealthPieChart(peopleData)}</div>
            <DashedDivider/>
            {renderBarVisualization('PAYMENT VISUALIZATION',[...peopleData].sort((a,b)=>b.wealth-a.wealth),[{label:'PAID',getValue:p=>p.paid,displayValue:p=>`${p.paidPct.toFixed(0)}%`,rightLabel:p=>formatCurrency(p.paid,2,shareCurrency)},{label:'FAIR',getValue:p=>p.fairShare,displayValue:p=>`${p.fairPct.toFixed(0)}%`,rightLabel:p=>formatCurrencySmart(p.fairShare,shareCurrency)}],p=>p.name)}
            <DashedDivider/>
            {renderMathSection(shareWeighting,[
              <div key="s1">{renderAdjustedWealthStep(1,peopleData,shareWeighting)}<div className="flex justify-between mt-2 pt-2 border-t border-dashed border-gray-400 font-bold"><span>TOTAL:</span><span className="font-mono">{formatSmartNumber(peopleData.reduce((s,p)=>s+p.adjustedWealth,0))}</span></div></div>,
              <div key="s2"><p className="font-bold mb-2">2. FAIR SHARE %:</p>{renderMathRow(peopleData,p=>{const ta=peopleData.reduce((s,pp)=>s+pp.adjustedWealth,0);return`${formatSmartNumber(p.adjustedWealth)} Ã· ${formatSmartNumber(ta)} = ${p.fairPct.toFixed(1)}%`;})}</div>,
              <div key="s3"><p className="font-bold mb-2">3. AMOUNT OWED:</p>{renderMathRow(peopleData,p=>`${p.fairPct.toFixed(1)}% Ã— ${formatCurrency(total,2,shareCurrency)} = ${formatCurrencySmart(p.fairShare,shareCurrency)}`)}</div>
            ],<div><p className="font-bold mb-2">EQUAL SPLIT (NO WEIGHTING):</p>{renderMathRow(peopleData,p=>`${formatCurrency(total,2,shareCurrency)} Ã· ${peopleData.length} = ${formatCurrencySmart(p.fairShare,shareCurrency)}`)}</div>)}
            <DashedDivider/>
          </div>}
        </>)}
        {renderResultsFooter(hasData,`Comrade | Bill-splitting results\n\nTotal: ${formatCurrency(total,2,shareCurrency)}\n\nBreakdown:\n${peopleData.map(p=>`${p.name}: Paid ${formatCurrency(p.paid,2,shareCurrency)}, fair share ${formatCurrencySmart(p.fairShare,shareCurrency)}`).join('\n')}\n\nSettlements:\n${transactions.length===0?'All settled!':transactions.map(t=>`${t.from} pays ${t.to} ${formatCurrencySmart(t.amount,shareCurrency)}`).join('\n')}\n\nCalculated using www.comrade.money`,'share-entry')}
      </Layout>
    );
  }

  if(page==='sale-entry'){
    const steps=[{label:'SELL',icon:<TagIcon size={22}/>},{label:'PRODUCT',icon:<ToteFilledIcon size={22}/>},{label:'BUYERS',icon:<PersonIcon size={22}/>},{label:'CALCULATE',icon:<CalculateIcon size={22}/>}];
    const jump=makeJump(setSaleOpen);
    const renderContent=i=>{
      if(i===0) return (
        <div>
          <p className="text-xs mb-5 text-black">If you're selling something, make sure it goes to the potential buyer who needs it the most â€” not just whoever offers to pay the most. Comrade takes into account prospective purchasers' financial resources to help you understand how much your product is truly worth to them.</p>
          <div className="flex flex-col gap-3">
            {hasSaleSavedData ? (
              <>
                <button onClick={()=>jump(1)} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">RESUME SALE â†’</button>
                <div className="flex gap-3">
                  <button onClick={()=>loadExample('sale')} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
                  <button onClick={()=>{handleClearAll('sale');jump(1);}} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">NEW SALE</button>
                </div>
              </>
            ) : (
              <>
                <button onClick={()=>{handleClearAll('sale');jump(1);}} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">NEW SALE â†’</button>
                <button onClick={()=>loadExample('sale')} className="w-full bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
              </>
            )}
          </div>
        </div>
      );
      if(i===1) return (<div><p className="text-xs mb-4 text-black">List what you're selling, and how many items are available.</p><FormInput value={productName} onChange={e=>setProductName(e.target.value)} placeholder="PRODUCT NAME" className="w-full mb-2"/><FormInput type="number" value={numberAvailable} onChange={e=>setNumberAvailable(e.target.value)} placeholder="NUMBER AVAILABLE" min="1" step="1" inputMode="numeric" className="w-full"/><div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(2)}/></div></div>);
      if(i===2) return (
        <div>
          <p className="text-xs mb-4 text-black">Add all the people interested in buying, along with their financial information.</p>
          <div className="border-2 border-dashed border-gray-400 p-3 mb-5">
            <div className="mb-3"><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">CURRENCY:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'USD',label:'$'},{value:'EUR',label:'â‚¬'},{value:'GBP',label:'Â£'}].map(c=><button key={c.value} onClick={()=>setSaleCurrency(c.value)} className={`px-4 py-2 font-bold text-xs border-2 ${saleCurrency===c.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{c.label}</button>)}</div></div></div></div>
            <div className="border-t border-dashed border-gray-400 my-3"></div>
            <div><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">WEALTH METRIC:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'salary',label:'SALARY'},{value:'networth',label:'NET WORTH'}].map(w=><button key={w.value} onClick={()=>setSaleWealthMetric(w.value)} className={`px-3 py-2 font-bold text-xs border-2 ${saleWealthMetric===w.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{w.label}</button>)}</div></div></div></div>
          </div>
          <div className="flex flex-col sm:flex-row gap-2 mb-2">
            <FormInput value={curBuyerName} onChange={e=>setCurBuyerName(e.target.value)} placeholder="NAME" className="flex-1" style={{minWidth:'120px'}}/>
            <FormInput type="number" value={curBuyerOffer} onChange={e=>setCurBuyerOffer(e.target.value)} placeholder={`${getCurrencySymbol(saleCurrency)} OFFER`} min="0" step="0.01" inputMode="decimal" className="flex-1" style={{minWidth:'120px'}}/>
          </div>
          <FormInput type="number" value={curBuyerWealth} onChange={e=>setCurBuyerWealth(e.target.value)} placeholder={`${getCurrencySymbol(saleCurrency)} ${getWealthMetricLabel(saleWealthMetric)}`} min="0" step="0.01" inputMode="decimal" className="w-full mb-3"/>
          <button onClick={()=>{if(curBuyerName.trim()){setSaleBuyers([...saleBuyers,{id:Date.now(),name:curBuyerName,wealth:curBuyerWealth,offer:curBuyerOffer}]);setCurBuyerName('');setCurBuyerWealth('');setCurBuyerOffer('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD BUYER</button>
          {saleBuyers.length>0?<ItemList items={saleBuyers} onDelete={id=>setSaleBuyers(saleBuyers.filter(b=>b.id!==id))} renderItem={b=><><p className="text-xs text-black font-bold uppercase">{b.name}</p><p className="text-xs text-black">{getWealthMetricLabel(saleWealthMetric)}: {formatCurrency(b.wealth,2,saleCurrency)}</p><p className="text-xs text-black">Offer: {formatCurrency(b.offer,2,saleCurrency)}</p></>}/>:<p className="text-center text-gray-600 uppercase tracking-wider font-bold mt-2" style={{fontSize:'10px'}}>â€” No buyers added yet â€”</p>}
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(3)}/></div>
        </div>
      );
      return (
        <div>
          <p className="text-xs mb-5 text-black">Tweak any settings, or just see your results.</p>
          {renderWeightingSection(saleWeighting, setSaleWeighting)}
          <div className="border-t border-dashed border-gray-400 my-4"></div>
          <button onClick={()=>navigateTo('sale-results')} className="bg-black text-white w-full py-4 font-black text-xl border-4 border-black hover:bg-gray-800 transition-all uppercase calculate-btn">CALCULATE</button>
        </div>
      );
    };
    return <Layout {...lp}><AccordionPage steps={steps} openIndices={saleOpen} onToggle={makeToggle(setSaleOpen)} renderContent={renderContent}/></Layout>;
  }

  if(page==='sale-results'){
    const {rankedBuyers,avgOffer}=saleCalculations;
    const numAvail=parseInt(numberAvailable)||1,winners=rankedBuyers.slice(0,numAvail);
    const hasData=saleBuyers.length>0&&productName.trim();
    const isTie=hasData&&rankedBuyers.length>1&&rankedBuyers[0].needScore===rankedBuyers[1].needScore&&rankedBuyers[0].needScore>0;
    return (
      <Layout {...lp}>
        {!hasData&&renderNoDataState('sale-entry')}
        {hasData&&(<>
          <div className="p-8 mb-4 border-4 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>
            <h3 className="text-xl font-black mb-4 uppercase tracking-wider pb-2" style={{borderBottom:`2px solid ${BG_GREY}`}}>SELECTED BUYER{winners.length>1?'S':''}</h3>
            {isTie?<p className="text-lg font-bold">PERFECT TIE. EVERYONE HAS EQUAL CLAIM.</p>:winners.map((w,i)=><div key={w.id} className="mb-3 pb-3" style={{borderBottom:`1px dashed ${BG_GREY}`}}><p className="text-3xl font-black mb-2">{w.name.toUpperCase()}</p><p className="text-xl font-semibold">OFFER: {formatCurrency(w.offer,2,saleCurrency)}</p><p className="text-xs" style={{color:BG_GREY}}>NEED SCORE: {w.needScore<0.01?w.needScore.toExponential(4):w.needScore.toFixed(2)}%</p></div>)}
            <BlackBoxStats stats={[{label:'PRODUCT',value:productName.toUpperCase()||'N/A'},{label:'AVAILABLE',value:numAvail},{label:'AVG OFFER',value:formatCurrency(avgOffer,2,saleCurrency)},{label:'WEIGHTING',value:getWeightingLabel(saleWeighting)}]}/>
          </div>
          <DetailToggleButton show={showSaleDetails} onClick={()=>setShowSaleDetails(!showSaleDetails)}/>
          {showSaleDetails&&<div className="animate-fadeIn">
            {renderDetailCards('BUYER DATA',rankedBuyers,(b,i)=>({name:`#${i+1} ${b.name}`,cardClassName:`p-4 border-2 ${i<numAvail?'border-black bg-gray-100':'border-gray-400 bg-white'}`,titleExtra:<span className={`px-2 py-1 text-xs font-bold border sf ${i<numAvail?'bg-black text-white border-black':'bg-white text-black border-black'}`}>{i<numAvail?'SELECTED':'NOT SELECTED'}</span>,rows:[{label:'WEALTH',value:formatCurrency(b.wealth,2,saleCurrency)},{label:'OFFER',value:formatCurrency(b.offer,2,saleCurrency)}],summaryRows:[{label:'NEED SCORE',value:`${b.needScore<0.01?b.needScore.toExponential(4):b.needScore.toFixed(2)}%`}]}))}
            <DashedDivider/>
            {renderBarVisualization('NEED SCORE VISUALIZATION',rankedBuyers,[{getValue:b=>b.needScore,displayValue:b=>`${b.needScore<0.01?b.needScore.toExponential(2):b.needScore.toFixed(1)}%`,rightLabel:(_,i)=>`#${i+1}`}],b=>b.name)}
            <DashedDivider/>
            {renderMathSection(saleWeighting,[renderAdjustedWealthStep(1,rankedBuyers,saleWeighting),<div key="s2"><p className="font-bold mb-2">2. NEED SCORE (OFFER Ã· ADJUSTED WEALTH Ã— 100):</p>{renderMathRow(rankedBuyers,b=>`${formatCurrency(b.offer,2,saleCurrency)} Ã· ${formatSmartNumber(b.adjustedWealth)} Ã— 100 = ${b.needScore<0.01?b.needScore.toExponential(2):b.needScore.toFixed(2)}%`)}</div>],<div><p className="font-bold mb-2">NO WEIGHTING - RANKED BY OFFER AMOUNT:</p>{rankedBuyers.map((b,i)=><div key={b.id} className="flex justify-between mb-1"><span>#{i+1} {b.name}:</span><span className="font-mono">{formatCurrency(b.offer,2,saleCurrency)}</span></div>)}</div>)}
            <DashedDivider/>
          </div>}
        </>)}
        {renderResultsFooter(hasData,`Comrade | Selling results\n\nProduct: ${productName||'Unnamed'}\nQuantity: ${numAvail}\n\nSelected buyer${winners.length>1?'s':''}:\n${winners.map(w=>`${w.name} - ${formatCurrency(w.offer,2,saleCurrency)}`).join('\n')}\n\nAll buyers ranked:\n${rankedBuyers.map((b,i)=>`${i+1}. ${b.name} - Offer: ${formatCurrency(b.offer,2,saleCurrency)}, need score: ${b.needScore.toFixed(4)}%`).join('\n')}\n\nCalculated using www.comrade.money`,'sale-entry')}
      </Layout>
    );
  }

  if(page==='vote-entry'){
    const steps=[{label:'VOTE',icon:<CheckCircleIcon size={22}/>},{label:'DECISION',icon:<QuestionIcon size={22}/>},{label:'OPTIONS',icon:<ListIcon size={22}/>},{label:'PEOPLE',icon:<PersonIcon size={22}/>},{label:'CALCULATE',icon:<CalculateIcon size={22}/>}];
    const jump=makeJump(setVoteOpen);
    const renderContent=i=>{
      if(i===0) return (
        <div>
          <p className="text-xs mb-5 text-black">Make group decisions more equitably with Comrade. If your friends, classmates, or coworkers are grappling with a dispute, give more voting power to those with less wealth.</p>
          <div className="flex flex-col gap-3">
            {hasVoteSavedData ? (
              <>
                <button onClick={()=>jump(1)} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">RESUME VOTE â†’</button>
                <div className="flex gap-3">
                  <button onClick={()=>loadExample('vote')} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
                  <button onClick={()=>{handleClearAll('vote');jump(1);}} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">NEW VOTE</button>
                </div>
              </>
            ) : (
              <>
                <button onClick={()=>{handleClearAll('vote');jump(1);}} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">NEW VOTE â†’</button>
                <button onClick={()=>loadExample('vote')} className="w-full bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
              </>
            )}
          </div>
        </div>
      );
      if(i===1) return (<div><p className="text-xs mb-4 text-black">Enter the question the group is voting on.</p><FormInput type="textarea" value={voteDecision} onChange={e=>setVoteDecision(e.target.value)} placeholder="DECISION TO BE MADE" rows={4} className="w-full"/><div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(2)}/></div></div>);
      if(i===2) return (<div><p className="text-xs mb-4 text-black">Add all the possible choices people can vote for.</p><FormInput value={curOptionText} onChange={e=>setCurOptionText(e.target.value)} placeholder="OPTION TEXT" className="w-full mb-3"/><button onClick={()=>{if(curOptionText.trim()){setVoteOptions([...voteOptions,{id:Date.now(),text:curOptionText}]);setCurOptionText('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD OPTION</button>{voteOptions.length>0?<div className="space-y-0">{voteOptions.map(opt=><div key={opt.id} className="flex justify-between items-center text-xs text-black border-b border-dashed border-gray-400 pb-2 pt-2"><p className="font-bold text-black uppercase flex-1">{opt.text}</p><button onClick={()=>setVoteOptions(voteOptions.filter(o=>o.id!==opt.id))} className="text-black font-bold text-xl ml-3 hover:text-gray-600 leading-none">Ã—</button></div>)}</div>:<p className="text-center text-gray-600 uppercase tracking-wider font-bold mt-2" style={{fontSize:'10px'}}>â€” No options added yet â€”</p>}<div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(3)}/></div></div>);
      if(i===3) return (
        <div>
          <p className="text-xs mb-4 text-black">List the people in the group, their financial resources, and how they chose to vote.</p>
          <div className="border-2 border-dashed border-gray-400 p-3 mb-5">
            <div className="mb-3"><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">CURRENCY:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'USD',label:'$'},{value:'EUR',label:'â‚¬'},{value:'GBP',label:'Â£'}].map(c=><button key={c.value} onClick={()=>setVoteCurrency(c.value)} className={`px-4 py-2 font-bold text-xs border-2 ${voteCurrency===c.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{c.label}</button>)}</div></div></div></div>
            <div className="border-t border-dashed border-gray-400 my-3"></div>
            <div><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">WEALTH METRIC:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'salary',label:'SALARY'},{value:'networth',label:'NET WORTH'}].map(w=><button key={w.value} onClick={()=>setVoteWealthMetric(w.value)} className={`px-3 py-2 font-bold text-xs border-2 ${voteWealthMetric===w.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{w.label}</button>)}</div></div></div></div>
          </div>
          <div className="flex flex-col sm:flex-row gap-2 mb-2">
            <FormInput value={curParticipantName} onChange={e=>setCurParticipantName(e.target.value)} placeholder="NAME" className="flex-1" style={{minWidth:'120px'}}/>
            <select value={curParticipantVote} onChange={e=>setCurParticipantVote(e.target.value)} className="flex-1 p-2 border-2 border-gray-400 bg-white uppercase" style={{minWidth:'120px',height:'42px',fontSize:'16px'}}>
              <option value="">VOTE</option>
              {voteOptions.map((opt,j)=><option key={opt.id||j} value={opt.text}>{opt.text}</option>)}
            </select>
          </div>
          <FormInput type="number" value={curParticipantWealth} onChange={e=>setCurParticipantWealth(e.target.value)} placeholder={`${getCurrencySymbol(voteCurrency)} ${getWealthMetricLabel(voteWealthMetric)}`} min="0" step="0.01" inputMode="decimal" className="w-full mb-3"/>
          <button onClick={()=>{if(curParticipantName.trim()){setVoteParticipants([...voteParticipants,{id:Date.now(),name:curParticipantName,wealth:curParticipantWealth,vote:curParticipantVote}]);setCurParticipantName('');setCurParticipantWealth('');setCurParticipantVote('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD PERSON</button>
          {voteParticipants.length>0?<ItemList items={voteParticipants} onDelete={id=>setVoteParticipants(voteParticipants.filter(p=>p.id!==id))} renderItem={p=><><p className="text-xs text-black font-bold uppercase">{p.name}</p><p className="text-xs text-black">{getWealthMetricLabel(voteWealthMetric)}: {formatCurrency(p.wealth,2,voteCurrency)}</p><p className="text-xs text-black">Vote: {p.vote||'Not selected'}</p></>}/>:<p className="text-center text-gray-600 uppercase tracking-wider font-bold mt-2" style={{fontSize:'10px'}}>â€” No people added yet â€”</p>}
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(4)}/></div>
        </div>
      );
      return (
        <div>
          <p className="text-xs mb-5 text-black">Tweak any settings, or just see your results.</p>
          {renderWeightingSection(voteWeighting, setVoteWeighting)}
          <div className="border-t border-dashed border-gray-400 my-4"></div>
          <button onClick={()=>navigateTo('vote-results')} className="bg-black text-white w-full py-4 font-black text-xl border-4 border-black hover:bg-gray-800 transition-all uppercase calculate-btn">CALCULATE</button>
        </div>
      );
    };
    return <Layout {...lp}><AccordionPage steps={steps} openIndices={voteOpen} onToggle={makeToggle(setVoteOpen)} renderContent={renderContent}/></Layout>;
  }

  if(page==='vote-results'){
    const {participantsData,totalVotingPower,voteBreakdown}=voteCalculations;
    const optTexts=voteOptions.map(o=>o.text);
    const hasOrphaned=voteParticipants.some(p=>p.vote&&!optTexts.includes(p.vote));
    const hasData=voteParticipants.length>0&&voteDecision.trim()&&voteOptions.length>0&&!hasOrphaned;
    const winner=voteBreakdown.length>0?voteBreakdown[0]:null;
    const isTie=hasData&&voteBreakdown.length>1&&voteBreakdown[0].percentage===voteBreakdown[1].percentage;
    return (
      <Layout {...lp}>
        {!hasData&&renderNoDataState('vote-entry')}
        {hasData&&(<>
          <div className="p-8 mb-4 border-4 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>
            <h3 className="text-xl font-black mb-4 uppercase tracking-wider pb-2" style={{borderBottom:`2px solid ${BG_GREY}`}}>DECISION</h3>
            <p className="text-lg mb-6 font-semibold">{voteDecision.toUpperCase()}</p>
            {isTie?<p className="text-xl font-bold">PERFECT TIE. NO CLEAR WINNER.</p>:winner?<><p className="text-sm mb-2">WINNING OPTION:</p><p className="text-3xl font-black mb-2">{winner.option.toUpperCase()}</p><p className="text-xl font-semibold">{winner.percentage.toFixed(1)}% OF VOTING POWER</p></>:<p className="text-lg font-bold">NO VOTES CAST</p>}
            <BlackBoxStats stats={[{label:'PARTICIPANTS',value:voteParticipants.length},{label:'OPTIONS',value:voteOptions.length},{label:'WEIGHTING',value:getWeightingLabel(voteWeighting)}]}/>
          </div>
          <DetailToggleButton show={showVoteDetails} onClick={()=>setShowVoteDetails(!showVoteDetails)}/>
          {showVoteDetails&&<div className="animate-fadeIn">
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">VOTE BREAKDOWN</h3><div className="space-y-4">{voteBreakdown.map((item,i)=><div key={i} className="border-2 border-gray-400 p-4"><div className="flex justify-between items-start mb-3 border-b border-dashed border-gray-400 pb-2"><p className="font-bold text-sm text-black uppercase">{item.option}</p><span className="px-2 py-1 text-xs font-bold border sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>{item.percentage.toFixed(1)}%</span></div><p className="text-xs text-black mb-2 font-bold">VOTERS ({item.voters.length}):</p><div className="space-y-1">{item.voters.map(v=><p key={v.name} className="text-xs text-black">â€¢ {v.name} (Power: {v.votingPower.toFixed(2)})</p>)}</div></div>)}</div></div>
            <DashedDivider/>
            {renderDetailCards('PARTICIPANT DATA',[...participantsData].sort((a,b)=>b.wealth-a.wealth),p=>({name:p.name,rows:[{label:'WEALTH',value:formatCurrency(p.wealth,2,voteCurrency)},{label:'VOTE',value:p.vote||'NO VOTE'}],summaryRows:[{label:'VOTING POWER',value:p.votingPower.toFixed(2)}]}))}
            <DashedDivider/>
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">VOTE DISTRIBUTION</h3><div className="space-y-3">{voteBreakdown.map((item,idx)=>{const up=participantsData.length>0?(participantsData.filter(p=>p.vote===item.option).length/participantsData.length)*100:0;const mx=Math.max(...voteBreakdown.map(b=>b.percentage));return<div key={idx} className="mb-4"><p className="font-bold text-black mb-1 text-xs uppercase">{item.option}</p><div className="space-y-1">{[{lbl:'WEIGHTED',pct:item.percentage},{lbl:'UNWEIGHTED',pct:up}].map(({lbl,pct},bi)=><div key={bi} className="flex items-center gap-2"><span className="text-xs text-black w-24 font-bold">{lbl}:</span><div className="flex-1 bg-gray-200 h-6 relative overflow-hidden border border-gray-400"><div className="h-6 bar-animate flex items-center justify-end pr-2 sf" style={{width:`${mx>0?(pct/mx)*100:0}%`,animationDelay:`${idx*0.1+bi*0.05}s`,backgroundColor:DARK}}>{mx>0&&(pct/mx)*100>15&&<span className="text-xs font-bold" style={{color:BG_GREY}}>{pct.toFixed(1)}%</span>}</div></div><span className="text-xs font-bold text-black w-16 text-right">{pct.toFixed(1)}%</span></div>)}</div></div>;})}
            </div></div>
            <DashedDivider/>
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">WEALTH VISUALIZATION</h3>{renderWealthPieChart(participantsData)}</div>
            <DashedDivider/>
            {renderMathSection(voteWeighting,[renderAdjustedWealthStep(1,participantsData,voteWeighting),<div key="v2"><p className="font-bold mb-2">2. AVERAGE WEALTH:</p><div className="flex justify-between mb-1"><span>TOTAL:</span><span className="font-mono">{formatSmartNumber(participantsData.reduce((s,p)=>s+p.wealth,0))}</span></div><div className="flex justify-between mb-1"><span>AVERAGE:</span><span className="font-mono">{formatSmartNumber(participantsData.reduce((s,p)=>s+p.wealth,0)/participantsData.length)}</span></div></div>,<div key="v3"><p className="font-bold mb-2">3. VOTING POWER (AVG Ã· ADJUSTED):</p>{renderMathRow(participantsData,p=>{const avg=participantsData.reduce((s,pp)=>s+pp.wealth,0)/participantsData.length;return`${formatSmartNumber(avg)} Ã· ${formatSmartNumber(p.adjustedWealth)} = ${p.votingPower.toFixed(2)}`;})}<div className="flex justify-between mt-2 pt-2 border-t border-dashed border-gray-400 font-bold"><span>TOTAL POWER:</span><span className="font-mono">{totalVotingPower.toFixed(2)}</span></div></div>],<div><p className="font-bold mb-2">EQUAL VOTING POWER (NO WEIGHTING):</p>{renderMathRow(participantsData,()=>'1 vote')}</div>)}
            <DashedDivider/>
          </div>}
        </>)}
        {renderResultsFooter(hasData,`Comrade | Voting results\n\nDecision: ${voteDecision}\n\nWinner: ${winner?`${winner.option} (${winner.percentage.toFixed(1)}%)`:'None'}\n\nBreakdown:\n${voteBreakdown.map((b,i)=>`${i+1}. ${b.option}: ${b.percentage.toFixed(1)}% (${b.voters.length} voter${b.voters.length!==1?'s':''})`).join('\n')}\n\nCalculated using www.comrade.money`,'vote-entry')}
      </Layout>
    );
  }

  if(page==='rent-entry'){
    const steps=[{label:'SPLIT RENT',icon:<HouseIcon size={22}/>},{label:'COSTS',icon:<BillIcon size={22}/>},{label:'TENANTS',icon:<PersonIcon size={22}/>},{label:'CALCULATE',icon:<CalculateIcon size={22}/>}];
    const jump=makeJump(setRentOpen);
    const renderContent=i=>{
      if(i===0) return (
        <div>
          <p className="text-xs mb-5 text-black">Figuring out rent splits with roommates is a fraught process. Decide it more fairly with Comrade by accounting for both room size and tenants' financial resources. Larger rooms and higher earners both pay more.</p>
          <div className="flex flex-col gap-3">
            {hasRentSavedData ? (
              <>
                <button onClick={()=>jump(1)} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">RESUME SPLIT â†’</button>
                <div className="flex gap-3">
                  <button onClick={()=>loadExample('rent')} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
                  <button onClick={()=>{handleClearAll('rent');jump(1);}} className="flex-1 bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">NEW SPLIT</button>
                </div>
              </>
            ) : (
              <>
                <button onClick={()=>{handleClearAll('rent');jump(1);}} className="w-full bg-black text-white py-3 font-bold text-sm border-2 border-black hover:bg-gray-800 transition-all">NEW SPLIT â†’</button>
                <button onClick={()=>loadExample('rent')} className="w-full bg-white text-black font-bold py-2 px-4 border-2 border-black text-xs hover:bg-gray-100 transition-all">EXAMPLE DATA</button>
              </>
            )}
          </div>
        </div>
      );
      if(i===1) return (
        <div>
          <p className="text-xs mb-4 text-black">List your total monthly rent, and monthly utility costs.</p>
          <div className="border-2 border-dashed border-gray-400 p-3 mb-5"><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">CURRENCY:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'USD',label:'$'},{value:'EUR',label:'â‚¬'},{value:'GBP',label:'Â£'}].map(c=><button key={c.value} onClick={()=>setRentCurrency(c.value)} className={`px-4 py-2 font-bold text-xs border-2 ${rentCurrency===c.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{c.label}</button>)}</div></div></div></div>
          <FormInput type="number" value={totalRent} onChange={e=>setTotalRent(e.target.value)} placeholder={`${getCurrencySymbol(rentCurrency)} MONTHLY RENT`} min="0" step="0.01" inputMode="decimal" className="w-full mb-2"/>
          <FormInput type="number" value={totalUtilities} onChange={e=>setTotalUtilities(e.target.value)} placeholder={`${getCurrencySymbol(rentCurrency)} MONTHLY UTILITIES`} min="0" step="0.01" inputMode="decimal" className="w-full"/>
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(2)}/></div>
        </div>
      );
      if(i===2) return (
        <div>
          <p className="text-xs mb-4 text-black">Add the names and details of each person sharing the property.</p>
          <div className="border-2 border-dashed border-gray-400 p-3 mb-5">
            <div className="mb-3"><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">MEASUREMENTS:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'sqft',label:'SQ FT'},{value:'sqm',label:'SQ M'}].map(m=><button key={m.value} onClick={()=>setRentMeasurement(m.value)} className={`px-4 py-2 font-bold text-xs border-2 ${rentMeasurement===m.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{m.label}</button>)}</div></div></div></div>
            <div className="border-t border-dashed border-gray-400 my-3"></div>
            <div><p className="text-xs font-bold mb-2 text-black uppercase tracking-wider">WEALTH METRIC:</p><div className="flex justify-center"><div className="bg-gray-100 p-1 border-2 border-dotted border-black inline-block"><div className="flex gap-1">{[{value:'salary',label:'SALARY'},{value:'networth',label:'NET WORTH'}].map(w=><button key={w.value} onClick={()=>setRentWealthMetric(w.value)} className={`px-3 py-2 font-bold text-xs border-2 ${rentWealthMetric===w.value?'bg-black text-white border-black':'bg-white text-black border-gray-400'}`}>{w.label}</button>)}</div></div></div></div>
          </div>
          <div className="flex flex-col sm:flex-row gap-2 mb-2">
            <FormInput value={curRoommateName} onChange={e=>setCurRoommateName(e.target.value)} placeholder="NAME" className="flex-1" style={{minWidth:'120px'}}/>
            <FormInput type="number" value={curRoommateRoomSize} onChange={e=>setCurRoommateRoomSize(e.target.value)} placeholder={`ROOM SIZE (${getMeasurementLabel(rentMeasurement)})`} min="0" step="0.01" inputMode="decimal" className="flex-1" style={{minWidth:'150px'}}/>
          </div>
          <FormInput type="number" value={curRoommateWealth} onChange={e=>setCurRoommateWealth(e.target.value)} placeholder={`${getCurrencySymbol(rentCurrency)} ${getWealthMetricLabel(rentWealthMetric)}`} min="0" step="0.01" inputMode="decimal" className="w-full mb-3"/>
          <button onClick={()=>{if(curRoommateName.trim()){setRentPeople([...rentPeople,{id:Date.now(),name:curRoommateName,roomSize:curRoommateRoomSize,wealth:curRoommateWealth}]);setCurRoommateName('');setCurRoommateRoomSize('');setCurRoommateWealth('');}}} className="bg-black text-white px-4 py-2 font-bold border-2 border-black text-xs mb-4">+ ADD TENANT</button>
          {rentPeople.length>0?<ItemList items={rentPeople} onDelete={id=>setRentPeople(rentPeople.filter(p=>p.id!==id))} renderItem={p=><><p className="text-xs text-black font-bold uppercase">{p.name}</p><p className="text-xs text-black">Room: {formatNumber((parseFloat(p.roomSize)||0).toFixed(0))} {getMeasurementLabel(rentMeasurement).toLowerCase()}</p><p className="text-xs text-black">{getWealthMetricLabel(rentWealthMetric)}: {formatCurrency(p.wealth,2,rentCurrency)}</p></>}/>:<p className="text-center text-gray-600 uppercase tracking-wider font-bold mt-2" style={{fontSize:'10px'}}>â€” No tenants added yet â€”</p>}
          <div className="mt-6"><NavButton label="CONTINUE â†’" onClick={()=>jump(3)}/></div>
        </div>
      );
      return (
        <div>
          <p className="text-xs mb-5 text-black">Tweak any settings, or just see your results.</p>
          <div className="mb-3">
            <AdvancedSettingsToggle isOpen={rentAdvancedOpen} onToggle={()=>setRentAdvancedOpen(o=>!o)}/>
            {rentAdvancedOpen&&renderAdvancedSettingsContent({weighting:rentWeighting,onWeightingChange:setRentWeighting,floor:rentFloor,onFloorChange:setRentFloor})}
          </div>
          <button onClick={()=>navigateTo('rent-results')} className="bg-black text-white w-full py-4 font-black text-xl border-4 border-black hover:bg-gray-800 transition-all uppercase calculate-btn">CALCULATE</button>
        </div>
      );
    };
    return <Layout {...lp}><AccordionPage steps={steps} openIndices={rentOpen} onToggle={makeToggle(setRentOpen)} renderContent={renderContent}/></Layout>;
  }

  if(page==='rent-results'){
    const {rentAmount,utilitiesAmount,total,totalRoomSize,rentData,totalRoomValue}=rentCalculations;
    const hasData=rentPeople.length>0&&parseFloat(totalRent)>0;
    return (
      <Layout {...lp}>
        {!hasData&&renderNoDataState('rent-entry')}
        {hasData&&(<>
          <div className="p-8 mb-4 border-4 sf" style={{backgroundColor:DARK,color:BG_GREY,borderColor:DARK}}>
            <h3 className="text-xl font-black mb-4 uppercase tracking-wider pb-2" style={{borderBottom:`2px solid ${BG_GREY}`}}>MONTHLY PAYMENTS</h3>
            <div className="space-y-3">{rentData.map(p=><div key={p.id} className="pb-2" style={{borderBottom:`1px dashed ${BG_GREY}`}}><p className="text-lg font-semibold">{p.name.toUpperCase()}</p><p className="text-2xl font-black">{formatCurrencySmart(p.fairRent,rentCurrency)}</p><p className="text-xs" style={{color:BG_GREY}}>{p.rentPct.toFixed(1)}% of total</p></div>)}</div>
            <BlackBoxStats stats={[{label:'RENT',value:formatCurrency(rentAmount,2,rentCurrency)},{label:'UTILITIES',value:formatCurrency(utilitiesAmount,2,rentCurrency)},{label:'TOTAL',value:formatCurrency(total,2,rentCurrency)},{label:'TENANTS',value:rentPeople.length},{label:'WEIGHTING',value:getWeightingLabel(rentWeighting)}]}/>
          </div>
          <DetailToggleButton show={showRentDetails} onClick={()=>setShowRentDetails(!showRentDetails)}/>
          {showRentDetails&&<div className="animate-fadeIn">
            {renderDetailCards('ROOMMATE DATA',rentData,p=>({name:p.name,rows:[{label:'ROOM SIZE',value:`${formatNumber(p.roomSize.toFixed(0))} ${getMeasurementLabel(rentMeasurement).toLowerCase()}`},{label:'WEALTH',value:formatCurrency(p.wealth,2,rentCurrency)}],summaryRows:[{label:'MONTHLY RENT',value:formatCurrencySmart(p.fairRent,rentCurrency)},{label:'% OF TOTAL',value:`${p.rentPct.toFixed(1)}%`}]}))}
            <DashedDivider/>
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">RENT AND ROOM SIZE BREAKDOWN</h3><div className="space-y-3">{rentData.map((p,idx)=>{const mxR=Math.max(...rentData.map(d=>d.fairRent));return<div key={p.id||idx} className="mb-4"><p className="font-bold text-black mb-1 text-xs uppercase">{p.name}</p><div className="space-y-1">{[{lbl:'RENT',v:p.fairRent,mx:mxR,disp:`${p.rentPct.toFixed(0)}%`,right:formatCurrencySmart(p.fairRent,rentCurrency)},{lbl:'ROOM',v:p.roomSize,mx:totalRoomSize,disp:`${p.roomPct.toFixed(0)}%`,right:`${formatNumber(p.roomSize.toFixed(0))} ${getMeasurementLabel(rentMeasurement).toLowerCase()}`}].map(({lbl,v,mx,disp,right},bi)=><div key={bi} className="flex items-center gap-2"><span className="text-xs text-black w-20 font-bold">{lbl}:</span><div className="flex-1 bg-gray-200 h-6 relative overflow-hidden border border-gray-400"><div className="h-6 bar-animate flex items-center justify-end pr-2 sf" style={{width:`${mx>0?(v/mx)*100:0}%`,animationDelay:`${idx*0.1+bi*0.05}s`,backgroundColor:DARK}}>{mx>0&&(v/mx)*100>15&&<span className="text-xs font-bold" style={{color:BG_GREY}}>{disp}</span>}</div></div><span className="text-xs font-bold text-black w-24 text-right">{right}</span></div>)}</div></div>;})}
            </div></div>
            <DashedDivider/>
            <div className="mb-6"><h3 className="text-lg font-bold mb-4 text-black uppercase tracking-wider">WEALTH VISUALIZATION</h3>{renderWealthPieChart(rentData)}</div>
            <DashedDivider/>
            {renderMathSection(rentWeighting,[<div key="r1"><p className="font-bold mb-2">1. ROOM SIZE %:</p>{renderMathRow(rentData,p=>`${formatNumber(p.roomSize.toFixed(0))} Ã· ${formatNumber(totalRoomSize.toFixed(0))} = ${p.roomPct.toFixed(1)}%`)}</div>,renderAdjustedWealthStep(2,rentData,rentWeighting),<div key="r3"><p className="font-bold mb-2">3. ROOM VALUE (ROOM % Ã— ADJUSTED WEALTH):</p>{renderMathRow(rentData,p=>`${p.roomPct.toFixed(1)}% Ã— ${formatSmartNumber(p.adjustedWealth)} = ${formatSmartNumber(p.roomValue)}`)}<div className="flex justify-between mt-2 pt-2 border-t border-dashed border-gray-400 font-bold"><span>TOTAL VALUE:</span><span className="font-mono">{formatSmartNumber(totalRoomValue)}</span></div></div>,<div key="r4"><p className="font-bold mb-2">4. RENT OWED (VALUE % Ã— TOTAL):</p>{renderMathRow(rentData,p=>`${p.rentPct.toFixed(1)}% Ã— ${formatCurrency(total,2,rentCurrency)} = ${formatCurrencySmart(p.fairRent,rentCurrency)}`)}</div>],<><div><p className="font-bold mb-2">1. ROOM SIZE % (NO WEALTH WEIGHTING):</p>{renderMathRow(rentData,p=>`${formatNumber(p.roomSize.toFixed(0))} Ã· ${formatNumber(totalRoomSize.toFixed(0))} = ${p.roomPct.toFixed(1)}%`)}</div><div className="border-t-2 border-dashed border-gray-400 my-3"></div><div><p className="font-bold mb-2">2. RENT OWED (ROOM % Ã— TOTAL):</p>{renderMathRow(rentData,p=>`${p.rentPct.toFixed(1)}% Ã— ${formatCurrency(total,2,rentCurrency)} = ${formatCurrencySmart(p.fairRent,rentCurrency)}`)}</div></>)}
            <DashedDivider/>
          </div>}
        </>)}
        {renderResultsFooter(hasData,`Comrade | Rent-splitting results\n\nTotal: ${formatCurrency(total,2,rentCurrency)}/month\nRent: ${formatCurrency(rentAmount,2,rentCurrency)}\nUtilities: ${formatCurrency(utilitiesAmount,2,rentCurrency)}\n\nBreakdown:\n${rentData.map(p=>`${p.name}: ${formatCurrencySmart(p.fairRent,rentCurrency)} (${p.rentPct.toFixed(1)}%)`).join('\n')}\n\nCalculated using www.comrade.money`,'rent-entry')}
      </Layout>
    );
  }

  return null;
};



// Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Comrade />);
    </script>
</body>
</html>
